<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"><meta name="apple-mobile-web-app-capable" content="yes"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><style>.bespoke-marp-note,.bespoke-marp-osc,.bespoke-progress-parent{display:none;transition:none}@media screen{body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:0;color:inherit;cursor:pointer;font-size:inherit;opacity:.8;outline:none;padding:0;transition:opacity .2s linear;-webkit-tap-highlight-color:transparent}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:disabled,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:disabled,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:disabled{cursor:not-allowed;opacity:.15!important}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover{opacity:1}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:active,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:active,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover:active{opacity:.6}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:not(:disabled),body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:not(:disabled),body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover:not(:disabled){transition:none}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button.bespoke-marp-presenter-info-page-prev{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJNNjggOTBMMjggNTBsNDAtNDAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button.bespoke-marp-presenter-info-page-next{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJNMzIgOTBsNDAtNDAtNDAtNDAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen]{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48c3R5bGU+LmF7ZmlsbDpub25lO3N0cm9rZTojZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2Utd2lkdGg6NXB4fTwvc3R5bGU+PC9kZWZzPjxyZWN0IGNsYXNzPSJhIiB4PSIxMCIgeT0iMjAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI2MCIgcng9IjUuNjciLz48cGF0aCBjbGFzcz0iYSIgZD0iTTQwIDcwSDIwVjUwbTIwIDBMMjAgNzBtNDAtNDBoMjB2MjBtLTIwIDBsMjAtMjAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button.exit[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button.exit[data-bespoke-marp-osc=fullscreen]{background-image:url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48c3R5bGU+LmF7ZmlsbDpub25lO3N0cm9rZTojZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2Utd2lkdGg6NXB4fTwvc3R5bGU+PC9kZWZzPjxyZWN0IGNsYXNzPSJhIiB4PSIxMCIgeT0iMjAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI2MCIgcng9IjUuNjciLz48cGF0aCBjbGFzcz0iYSIgZD0iTTIwIDUwaDIwdjIwbS0yMCAwbDIwLTIwbTQwIDBINjBWMzBtMjAgMEw2MCA1MCIvPjwvc3ZnPg==")}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter]{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48c3R5bGU+LmF7ZmlsbDpub25lO3N0cm9rZTojZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS13aWR0aDo1cHh9PC9zdHlsZT48L2RlZnM+PHBhdGggY2xhc3M9ImEiIGQ9Ik0yMCA2MGgtNWE1IDUgMCAwMS01LTVWMjBhNSA1IDAgMDE1LTVoNjBhNSA1IDAgMDE1IDV2NU0zMCA4NWg2MCIvPjxyZWN0IHg9IjMwIiB5PSIzNSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiByeD0iNSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIi8+PHJlY3QgY2xhc3M9ImEiIHg9IjMwIiB5PSIzNSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiByeD0iNSIvPjxwYXRoIGNsYXNzPSJhIiBkPSJNNDAgNTBoNDBNNDAgNjBoMzAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body,html{height:100%;margin:0}body{background:#000;overflow:hidden}svg.bespoke-marp-slide{content-visibility:hidden;z-index:-1;pointer-events:none;opacity:0}svg.bespoke-marp-slide.bespoke-marp-active{content-visibility:visible;z-index:0;pointer-events:auto;opacity:1}svg.bespoke-marp-slide.bespoke-marp-active.bespoke-marp-active-ready *{-webkit-animation-name:__bespoke_marp__!important;animation-name:__bespoke_marp__!important}@supports not (content-visibility:hidden){svg.bespoke-marp-slide[data-bespoke-marp-load=hideable]{display:none}svg.bespoke-marp-slide[data-bespoke-marp-load=hideable].bespoke-marp-active{display:block}}[data-bespoke-marp-fragment=inactive]{visibility:hidden}body[data-bespoke-view=""] .bespoke-marp-parent,body[data-bespoke-view=next] .bespoke-marp-parent{bottom:0;left:0;position:absolute;right:0;top:0}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc{background:rgba(0,0,0,.65);border-radius:7px;bottom:50px;color:#fff;display:block;font-family:Helvetica,Arial,sans-serif;font-size:16px;left:50%;line-height:0;opacity:1;padding:12px;position:absolute;touch-action:manipulation;transform:translateX(-50%);transition:opacity .2s linear;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap;z-index:1;will-change:transform}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>*,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>*{margin-left:6px}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>:first-child,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>:first-child{margin-left:0}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>span,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>span{opacity:.8}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>span[data-bespoke-marp-osc=page],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>span[data-bespoke-marp-osc=page]{display:inline-block;min-width:140px;text-align:center}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev]{height:32px;line-height:32px;width:32px}body[data-bespoke-view=""] .bespoke-marp-parent.bespoke-marp-inactive,body[data-bespoke-view=next] .bespoke-marp-parent.bespoke-marp-inactive{cursor:none}body[data-bespoke-view=""] .bespoke-marp-parent.bespoke-marp-inactive>.bespoke-marp-osc,body[data-bespoke-view=next] .bespoke-marp-parent.bespoke-marp-inactive>.bespoke-marp-osc{opacity:0;pointer-events:none}body[data-bespoke-view=""] svg.bespoke-marp-slide,body[data-bespoke-view=next] svg.bespoke-marp-slide{height:100%;left:0;position:absolute;top:0;width:100%}body[data-bespoke-view=""] .bespoke-progress-parent{background:#222;display:flex;height:5px;width:100%}body[data-bespoke-view=""] .bespoke-progress-parent+.bespoke-marp-parent{top:5px}body[data-bespoke-view=""] .bespoke-progress-parent .bespoke-progress-bar{flex:0 0 0;background:#0288d1;transition:flex-basis .2s cubic-bezier(0,1,1,1)}body[data-bespoke-view=next]{background:transparent}body[data-bespoke-view=presenter]{background:#161616}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container{font-family:Helvetica,Arial,sans-serif;height:100%;left:0;position:absolute;top:0;width:100%;display:grid;grid-template-columns:2fr 1fr;grid-template-rows:minmax(140px,1fr) 2fr 3em;grid-template-areas:"current next" "current note" "info    note"}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent{grid-area:current;position:relative;overflow:hidden}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent svg.bespoke-marp-slide{height:calc(100% - 40px);left:20px;position:absolute;pointer-events:none;top:20px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:calc(100% - 40px)}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent svg.bespoke-marp-slide.bespoke-marp-active{filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container{background:#222;cursor:pointer;display:none;grid-area:next;overflow:hidden;position:relative}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container.active{display:block}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container iframe.bespoke-marp-presenter-next{background:transparent;border:0;display:block;filter:drop-shadow(0 3px 10px rgba(0,0,0,.5));height:calc(100% - 40px);left:20px;position:absolute;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;top:20px;width:calc(100% - 40px)}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container{background:#222;color:#eee;grid-area:note}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note{margin:20px;width:calc(100% - 40px);height:calc(100% - 40px);box-sizing:border-box;font-size:1.1em;overflow:auto;padding-right:3px;white-space:pre-wrap;word-wrap:break-word;scrollbar-width:thin;scrollbar-color:hsla(0,0%,93.3%,.5) transparent}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar{width:6px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar-track{background:transparent}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar-thumb{background:hsla(0,0%,93.3%,.5);border-radius:6px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note:empty{pointer-events:none}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note.active{display:block}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note p:first-child{margin-top:0}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note p:last-child{margin-bottom:0}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container{align-items:center;box-sizing:border-box;color:#eee;display:flex;flex-wrap:nowrap;grid-area:info;justify-content:center;padding:0 10px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-time,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-timer{display:block;box-sizing:border-box;padding:0 10px;white-space:nowrap;width:100%}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button{height:1.5em;line-height:1.5em;width:1.5em}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page{order:2;text-align:center}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page .bespoke-marp-presenter-info-page-text{display:inline-block;min-width:120px;text-align:center}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-time{color:#999;order:1;text-align:left}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-timer{color:#999;order:3;text-align:right}}@media print{.bespoke-marp-presenter-info-container,.bespoke-marp-presenter-next-container,.bespoke-marp-presenter-note-container{display:none}}</style><style>@charset "UTF-8";@import url("https://fonts.googleapis.com/css?family=Lato:400,900|Roboto+Mono:400,700&display=swap");div#p>svg>foreignObject>section{width:1280px;height:720px;box-sizing:border-box;overflow:hidden;position:relative;scroll-snap-align:center center}div#p>svg>foreignObject>section:after{bottom:0;content:attr(data-marpit-pagination);padding:inherit;pointer-events:none;position:absolute;right:0}div#p>svg>foreignObject>section:not([data-marpit-pagination]):after{display:none}/* Normalization */div#p>svg>foreignObject>section h1{font-size:2em;margin:0.67em 0}div#p>svg>foreignObject>section video::-webkit-media-controls{will-change:transform}@page{size:1280px 720px;margin:0}@media print{body,html{background-color:#fff;margin:0;page-break-inside:avoid;break-inside:avoid-page}div#p>svg>foreignObject>section{page-break-before:always;break-before:page}div#p>svg>foreignObject>section,div#p>svg>foreignObject>section *{-webkit-print-color-adjust:exact!important;animation-delay:0s!important;animation-duration:0s!important;color-adjust:exact!important;transition:none!important}div#p>svg[data-marpit-svg]{display:block;height:100vh;width:100vw}}div#p>svg>foreignObject>section svg[data-marp-fitting=svg]{display:block;height:auto;width:100%}@supports (-ms-ime-align:auto){div#p>svg>foreignObject>section svg[data-marp-fitting=svg]{position:static}}div#p>svg>foreignObject>section svg[data-marp-fitting=svg].__reflow__{content:""}@supports (-ms-ime-align:auto){div#p>svg>foreignObject>section svg[data-marp-fitting=svg].__reflow__{position:relative}}div#p>svg>foreignObject>section [data-marp-fitting-svg-content]{display:table;white-space:nowrap}div#p>svg>foreignObject>section [data-marp-fitting-svg-content-wrap]{white-space:pre}div#p>svg>foreignObject>section img[data-marp-twemoji]{background:transparent;height:1em;margin:0 .05em 0 .1em;vertical-align:-.1em;width:1em}
/*!
 * Marp / Marpit Gaia theme.
 *
 * @theme gaia
 * @author Yuki Hattori
 *
 * @auto-scaling true
 * @size 4:3 960px 720px
 */div#p>svg>foreignObject>section .hljs{display:block;overflow-x:auto;padding:.5em;background:#000;color:#f8f8f8}div#p>svg>foreignObject>section .hljs-comment,div#p>svg>foreignObject>section .hljs-quote{color:#aeaeae;font-style:italic}div#p>svg>foreignObject>section .hljs-keyword,div#p>svg>foreignObject>section .hljs-selector-tag,div#p>svg>foreignObject>section .hljs-type{color:#e28964}div#p>svg>foreignObject>section .hljs-string{color:#65b042}div#p>svg>foreignObject>section .hljs-subst{color:#daefa3}div#p>svg>foreignObject>section .hljs-link,div#p>svg>foreignObject>section .hljs-regexp{color:#e9c062}div#p>svg>foreignObject>section .hljs-name,div#p>svg>foreignObject>section .hljs-section,div#p>svg>foreignObject>section .hljs-tag,div#p>svg>foreignObject>section .hljs-title{color:#89bdff}div#p>svg>foreignObject>section .hljs-class .hljs-title,div#p>svg>foreignObject>section .hljs-doctag{text-decoration:underline}div#p>svg>foreignObject>section .hljs-bullet,div#p>svg>foreignObject>section .hljs-number,div#p>svg>foreignObject>section .hljs-symbol{color:#3387cc}div#p>svg>foreignObject>section .hljs-params,div#p>svg>foreignObject>section .hljs-template-variable,div#p>svg>foreignObject>section .hljs-variable{color:#3e87e3}div#p>svg>foreignObject>section .hljs-attribute{color:#cda869}div#p>svg>foreignObject>section .hljs-meta{color:#8996a8}div#p>svg>foreignObject>section .hljs-formula{background-color:#0e2231;color:#f8f8f8;font-style:italic}div#p>svg>foreignObject>section .hljs-addition{background-color:#253b22;color:#f8f8f8}div#p>svg>foreignObject>section .hljs-deletion{background-color:#420e09;color:#f8f8f8}div#p>svg>foreignObject>section .hljs-selector-class{color:#9b703f}div#p>svg>foreignObject>section .hljs-selector-id{color:#8b98ab}div#p>svg>foreignObject>section .hljs-emphasis{font-style:italic}div#p>svg>foreignObject>section .hljs-strong{font-weight:700}div#p>svg>foreignObject>section svg[data-marp-fitting=svg]{max-height:580px}div#p>svg>foreignObject>section h1,div#p>svg>foreignObject>section h2,div#p>svg>foreignObject>section h3,div#p>svg>foreignObject>section h4,div#p>svg>foreignObject>section h5,div#p>svg>foreignObject>section h6{margin:.5em 0 0}div#p>svg>foreignObject>section h1 strong,div#p>svg>foreignObject>section h2 strong,div#p>svg>foreignObject>section h3 strong,div#p>svg>foreignObject>section h4 strong,div#p>svg>foreignObject>section h5 strong,div#p>svg>foreignObject>section h6 strong{font-weight:inherit}div#p>svg>foreignObject>section h1{font-size:1.8em}div#p>svg>foreignObject>section h2{font-size:1.5em}div#p>svg>foreignObject>section h3{font-size:1.3em}div#p>svg>foreignObject>section h4{font-size:1.1em}div#p>svg>foreignObject>section h5{font-size:1em}div#p>svg>foreignObject>section h6{font-size:.9em}div#p>svg>foreignObject>section blockquote,div#p>svg>foreignObject>section p{margin:1em 0 0}div#p>svg>foreignObject>section ol>li,div#p>svg>foreignObject>section ul>li{margin:.3em 0 0}div#p>svg>foreignObject>section ol>li>p,div#p>svg>foreignObject>section ul>li>p{margin:.6em 0 0}div#p>svg>foreignObject>section code{display:inline-block;font-family:Roboto Mono,monospace;font-size:.8em;letter-spacing:0;margin:-.1em .15em;padding:.1em .2em;vertical-align:baseline}div#p>svg>foreignObject>section pre{display:block;margin:1em 0 0;min-height:1em;overflow:visible}div#p>svg>foreignObject>section pre code{box-sizing:border-box;margin:0;min-width:100%;padding:.5em;font-size:.7em}div#p>svg>foreignObject>section pre code svg[data-marp-fitting=svg]{max-height:calc(580px - 1em)}div#p>svg>foreignObject>section blockquote{margin:1em 0 0;padding:0 1em;position:relative}div#p>svg>foreignObject>section blockquote:after,div#p>svg>foreignObject>section blockquote:before{content:"“";display:block;font-family:Times New Roman,serif;font-weight:700;position:absolute}div#p>svg>foreignObject>section blockquote:before{top:0;left:0}div#p>svg>foreignObject>section blockquote:after{right:0;bottom:0;transform:rotate(180deg)}div#p>svg>foreignObject>section blockquote>:first-child{margin-top:0}div#p>svg>foreignObject>section mark{background:transparent}div#p>svg>foreignObject>section table{border-spacing:0;border-collapse:collapse;margin:1em 0 0}div#p>svg>foreignObject>section table td,div#p>svg>foreignObject>section table th{padding:.2em .4em;border-width:1px;border-style:solid}div#p>svg>foreignObject>section{background-image:linear-gradient(135deg,hsla(0,0%,53.3%,0),hsla(0,0%,53.3%,.02) 50%,hsla(0,0%,100%,0) 0,hsla(0,0%,100%,.05));font-size:35px;font-family:Lato,Avenir Next,Avenir,Trebuchet MS,Segoe UI,sans-serif;height:720px;line-height:1.35;letter-spacing:1.25px;padding:70px;width:1280px;word-wrap:break-word;color:#455a64;background-color:#fff8e1}div#p>svg>foreignObject>section{--marpit-root-font-size:35px}div#p>svg>foreignObject>section>:first-child,div#p>svg>foreignObject>section>header:first-child+*{margin-top:0}div#p>svg>foreignObject>section a,div#p>svg>foreignObject>section mark{color:#0288d1}div#p>svg>foreignObject>section code{background:#6a7a7d;color:#fff8e1}div#p>svg>foreignObject>section h1 strong,div#p>svg>foreignObject>section h2 strong,div#p>svg>foreignObject>section h3 strong,div#p>svg>foreignObject>section h4 strong,div#p>svg>foreignObject>section h5 strong,div#p>svg>foreignObject>section h6 strong{color:#0288d1}div#p>svg>foreignObject>section pre>code{background:#455a64}div#p>svg>foreignObject>section blockquote:after,div#p>svg>foreignObject>section blockquote:before,div#p>svg>foreignObject>section footer,div#p>svg>foreignObject>section header,div#p>svg>foreignObject>section section:after{color:#6a7a7d}div#p>svg>foreignObject>section table td,div#p>svg>foreignObject>section table th{border-color:#455a64}div#p>svg>foreignObject>section table thead th{background:#455a64;color:#fff8e1}div#p>svg>foreignObject>section table tbody>tr:nth-child(odd) td,div#p>svg>foreignObject>section table tbody>tr:nth-child(odd) th{background:rgba(69,90,100,.1)}div#p>svg>foreignObject>section.invert{color:#fff8e1;background-color:#455a64}div#p>svg>foreignObject>section.invert a,div#p>svg>foreignObject>section.invert mark{color:#81d4fa}div#p>svg>foreignObject>section.invert code{background:#dad8c8;color:#455a64}div#p>svg>foreignObject>section.invert h1 strong,div#p>svg>foreignObject>section.invert h2 strong,div#p>svg>foreignObject>section.invert h3 strong,div#p>svg>foreignObject>section.invert h4 strong,div#p>svg>foreignObject>section.invert h5 strong,div#p>svg>foreignObject>section.invert h6 strong{color:#81d4fa}div#p>svg>foreignObject>section.invert pre>code{background:#fff8e1}div#p>svg>foreignObject>section.invert blockquote:after,div#p>svg>foreignObject>section.invert blockquote:before,div#p>svg>foreignObject>section.invert footer,div#p>svg>foreignObject>section.invert header,div#p>svg>foreignObject>section.invert section:after{color:#dad8c8}div#p>svg>foreignObject>section.invert table td,div#p>svg>foreignObject>section.invert table th{border-color:#fff8e1}div#p>svg>foreignObject>section.invert table thead th{background:#fff8e1;color:#455a64}div#p>svg>foreignObject>section.invert table tbody>tr:nth-child(odd) td,div#p>svg>foreignObject>section.invert table tbody>tr:nth-child(odd) th{background:rgba(255,248,225,.1)}div#p>svg>foreignObject>section.gaia{color:#fff8e1;background-color:#0288d1}div#p>svg>foreignObject>section.gaia a,div#p>svg>foreignObject>section.gaia mark{color:#81d4fa}div#p>svg>foreignObject>section.gaia code{background:#cce2de;color:#0288d1}div#p>svg>foreignObject>section.gaia h1 strong,div#p>svg>foreignObject>section.gaia h2 strong,div#p>svg>foreignObject>section.gaia h3 strong,div#p>svg>foreignObject>section.gaia h4 strong,div#p>svg>foreignObject>section.gaia h5 strong,div#p>svg>foreignObject>section.gaia h6 strong{color:#81d4fa}div#p>svg>foreignObject>section.gaia pre>code{background:#fff8e1}div#p>svg>foreignObject>section.gaia blockquote:after,div#p>svg>foreignObject>section.gaia blockquote:before,div#p>svg>foreignObject>section.gaia footer,div#p>svg>foreignObject>section.gaia header,div#p>svg>foreignObject>section.gaia section:after{color:#cce2de}div#p>svg>foreignObject>section.gaia table td,div#p>svg>foreignObject>section.gaia table th{border-color:#fff8e1}div#p>svg>foreignObject>section.gaia table thead th{background:#fff8e1;color:#0288d1}div#p>svg>foreignObject>section.gaia table tbody>tr:nth-child(odd) td,div#p>svg>foreignObject>section.gaia table tbody>tr:nth-child(odd) th{background:rgba(255,248,225,.1)}div#p>svg>foreignObject>section.lead{display:flex;flex-direction:column;flex-wrap:nowrap;justify-content:center}div#p>svg>foreignObject>section.lead h1,div#p>svg>foreignObject>section.lead h2,div#p>svg>foreignObject>section.lead h3,div#p>svg>foreignObject>section.lead h4,div#p>svg>foreignObject>section.lead h5,div#p>svg>foreignObject>section.lead h6{text-align:center}div#p>svg>foreignObject>section.lead h1 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h2 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h3 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h4 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h5 svg[data-marp-fitting=svg],div#p>svg>foreignObject>section.lead h6 svg[data-marp-fitting=svg]{--preserve-aspect-ratio:xMidYMid meet}div#p>svg>foreignObject>section.lead p{text-align:center}div#p>svg>foreignObject>section.lead blockquote>h1,div#p>svg>foreignObject>section.lead blockquote>h2,div#p>svg>foreignObject>section.lead blockquote>h3,div#p>svg>foreignObject>section.lead blockquote>h4,div#p>svg>foreignObject>section.lead blockquote>h5,div#p>svg>foreignObject>section.lead blockquote>h6,div#p>svg>foreignObject>section.lead blockquote>p{text-align:left}div#p>svg>foreignObject>section.lead blockquote svg[data-marp-fitting=svg]:not([data-marp-fitting-math]){--preserve-aspect-ratio:xMinYMin meet}div#p>svg>foreignObject>section.lead ol>li>p,div#p>svg>foreignObject>section.lead ul>li>p{text-align:left}div#p>svg>foreignObject>section.lead table{margin-left:auto;margin-right:auto}div#p>svg>foreignObject>section:after,div#p>svg>foreignObject>section footer,div#p>svg>foreignObject>section header{box-sizing:border-box;font-size:66%;height:70px;line-height:50px;overflow:hidden;padding:10px 25px;position:absolute}div#p>svg>foreignObject>section:after{--marpit-root-font-size:66%}div#p>svg>foreignObject>section header{top:0}div#p>svg>foreignObject>section footer,div#p>svg>foreignObject>section header{left:0;right:0}div#p>svg>foreignObject>section footer{bottom:0}div#p>svg>foreignObject>section:after{right:0;bottom:0;font-size:80%}div#p>svg>foreignObject>section:after{--marpit-root-font-size:80%}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]{display:block!important;padding:0!important}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]:after,div#p>svg>foreignObject>section[data-marpit-advanced-background=background]:before,div#p>svg>foreignObject>section[data-marpit-advanced-background=content]:after,div#p>svg>foreignObject>section[data-marpit-advanced-background=content]:before{display:none!important}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container]{all:initial;display:flex;flex-direction:row;height:100%;overflow:hidden;width:100%}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container][data-marpit-advanced-background-direction=vertical]{flex-direction:column}div#p>svg>foreignObject>section[data-marpit-advanced-background=background][data-marpit-advanced-background-split]>div[data-marpit-advanced-background-container]{width:var(--marpit-advanced-background-split,50%)}div#p>svg>foreignObject>section[data-marpit-advanced-background=background][data-marpit-advanced-background-split=right]>div[data-marpit-advanced-background-container]{margin-left:calc(100% - var(--marpit-advanced-background-split, 50%))}div#p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container]>figure{all:initial;background-position:center;background-repeat:no-repeat;background-size:cover;flex:auto;margin:0}div#p>svg>foreignObject>section[data-marpit-advanced-background=content],div#p>svg>foreignObject>section[data-marpit-advanced-background=pseudo]{background:transparent!important}div#p>svg>foreignObject>section[data-marpit-advanced-background=pseudo],div#p>svg[data-marpit-svg]>foreignObject[data-marpit-advanced-background=pseudo]{pointer-events:none!important}div#p>svg>foreignObject>section[data-marpit-advanced-background-split]{width:100%;height:100%}</style></head><body><div class="bespoke-marp-osc"><button data-bespoke-marp-osc="prev" tabindex="-1" title="Previous slide">Previous slide</button><span data-bespoke-marp-osc="page"></span><button data-bespoke-marp-osc="next" tabindex="-1" title="Next slide">Next slide</button><button data-bespoke-marp-osc="fullscreen" tabindex="-1" title="Toggle fullscreen (f)">Toggle fullscreen</button><button data-bespoke-marp-osc="presenter" tabindex="-1" title="Open presenter view (p)">Open presenter view</button></div><div id="p"><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="1" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-class="lead" data-theme="gaia" class="lead" data-marpit-pagination="1" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--class:lead;--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h1>第 10 章 数据聚合与分组运算</h1>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="2" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="2" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>对数据集进行分组并对各组应用一个函数（无论是聚合还是转换），通常是数据分析工作中的重要环节。在将数据集加载、融合、准备好之后，通常就是计算分组统计或生成透视表。pandas提供了一个灵活高效的gruopby功能，它使你能以一种自然的方式对数据集进行切片、切块、摘要等操作。</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="3" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="3" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>关系型数据库和SQL（Structured Query Language，结构化查询语言）能够如此流行的原因之一就是其能够方便地对数据进行连接、过滤、转换和聚合。但是，像SQL这样的查询语言所能执行的分组运算的种类很有限。在本章中你将会看到，由于Python和pandas强大的表达能力，我们可以执行复杂得多的分组运算（利用任何可以接受pandas对象或NumPy数组的函数）。在本章中，你将会学到：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="4" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="4" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<ul>
<li>使用一个或多个键（形式可以是函数、数组或DataFrame列名）分割pandas对象。</li>
<li>计算分组的概述统计，比如数量、平均值或标准差，或是用户定义的函数。</li>
<li>应用组内转换或其他运算，如规格化、线性回归、排名或选取子集等。</li>
<li>计算透视表或交叉表。</li>
<li>执行分位数分析以及其它统计分组分析。</li>
</ul>
<blockquote>
<p>笔记：对时间序列数据的聚合（groupby的特殊用法之一）也称作重采样（resampling），本书将在第11章中单独对其进行讲解。</p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="5" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="5" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h2>10.1 GroupBy机制</h2>
<p>Hadley Wickham（许多热门R语言包的作者）创造了一个用于表示分组运算的术语&quot;split-apply-combine&quot;（拆分－应用－合并）。第一个阶段，pandas对象（无论是Series、DataFrame还是其他的）中的数据会根据你所提供的一个或多个键被拆分（split）为多组。拆分操作是在对象的特定轴上执行的。例如，DataFrame可以在其行（axis=0）或列（axis=1）上进行分组。然后，将一个函数应用（apply）到各个分组并产生一个新值。最后，所有这些函数的执行结果会被合并（combine）到最终的结果对象中。结果对象的形式一般取决于数据上所执行的操作。图10-1大致说明了一个简单的分组聚合过程。</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="6" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="6" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p><img src="http://upload-images.jianshu.io/upload_images/7178691-e5c671e09ecf94be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图10-1 分组聚合演示 w:600" style="width:600px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="7" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="7" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>分组键可以有多种形式，且类型不必相同：</p>
<ul>
<li>列表或数组，其长度与待分组的轴一样。</li>
<li>表示DataFrame某个列名的值。</li>
<li>字典或Series，给出待分组轴上的值与分组名之间的对应关系。</li>
<li>函数，用于处理轴索引或索引中的各个标签。</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="8" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="8" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>注意，后三种都只是快捷方式而已，其最终目的仍然是产生一组用于拆分对象的值。如果觉得这些东西看起来很抽象，不用担心，我将在本章中给出大量有关于此的示例。首先来看看下面这个非常简单的表格型数据集（以DataFrame的形式）：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">10</span>]: df = pd.DataFrame({<span class="hljs-string">&#x27;key1&#x27;</span> : [<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>],
   ....:                    <span class="hljs-string">&#x27;key2&#x27;</span> : [<span class="hljs-string">&#x27;one&#x27;</span>, <span class="hljs-string">&#x27;two&#x27;</span>, <span class="hljs-string">&#x27;one&#x27;</span>, <span class="hljs-string">&#x27;two&#x27;</span>, <span class="hljs-string">&#x27;one&#x27;</span>],
   ....:                    <span class="hljs-string">&#x27;data1&#x27;</span> : np.random.randn(<span class="hljs-number">5</span>),
   ....:                    <span class="hljs-string">&#x27;data2&#x27;</span> : np.random.randn(<span class="hljs-number">5</span>)})

In [<span class="hljs-number">11</span>]: df
Out[<span class="hljs-number">11</span>]: 
      data1     data2 key1 key2
<span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>    a  one
<span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>    a  two
<span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one
<span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>    b  two
<span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>    a  one
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="9" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="9" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>假设你想要按key1进行分组，并计算data1列的平均值。实现该功能的方式有很多，而我们这里要用的是：访问data1，并根据key1调用groupby：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">12</span>]: grouped = df[<span class="hljs-string">&#x27;data1&#x27;</span>].groupby(df[<span class="hljs-string">&#x27;key1&#x27;</span>])

In [<span class="hljs-number">13</span>]: grouped
Out[<span class="hljs-number">13</span>]: &lt;pandas.core.groupby.SeriesGroupBy object at <span class="hljs-number">0x7faa31537390</span>&gt;
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="10" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="10" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>变量grouped是一个GroupBy对象。它实际上还没有进行任何计算，只是含有一些有关分组键df['key1']的中间数据而已。换句话说，该对象已经有了接下来对各分组执行运算所需的一切信息。例如，我们可以调用GroupBy的mean方法来计算分组平均值：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">14</span>]: grouped.mean()
Out[<span class="hljs-number">14</span>]: 
key1
a    <span class="hljs-number">0.746672</span>
b   <span class="hljs-number">-0.537585</span>
Name: data1, dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="11" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="11" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>稍后我将详细讲解.mean()的调用过程。这里最重要的是，数据（Series）根据分组键进行了聚合，产生了一个新的Series，其索引为key1列中的唯一值。之所以结果中索引的名称为key1，是因为原始DataFrame的列df['key1']就叫这个名字。</p>
<p>如果我们一次传入多个数组的列表，就会得到不同的结果：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">15</span>]: means = df[<span class="hljs-string">&#x27;data1&#x27;</span>].groupby([df[<span class="hljs-string">&#x27;key1&#x27;</span>], df[<span class="hljs-string">&#x27;key2&#x27;</span>]]).mean()

In [<span class="hljs-number">16</span>]: means
Out[<span class="hljs-number">16</span>]: 
key1  key2
a     one     <span class="hljs-number">0.880536</span>
      two     <span class="hljs-number">0.478943</span>
b     one    <span class="hljs-number">-0.519439</span>
      two    <span class="hljs-number">-0.555730</span>
Name: data1, dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="12" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="12" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>这里，我通过两个键对数据进行了分组，得到的Series具有一个层次化索引（由唯一的键对组成）：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">17</span>]: means.unstack()
Out[<span class="hljs-number">17</span>]: 
key2       one       two
key1                    
a     <span class="hljs-number">0.880536</span>  <span class="hljs-number">0.478943</span>
b    <span class="hljs-number">-0.519439</span> <span class="hljs-number">-0.555730</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="13" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="13" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>在这个例子中，分组键均为Series。实际上，分组键可以是任何长度适当的数组：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">18</span>]: states = np.array([<span class="hljs-string">&#x27;Ohio&#x27;</span>, <span class="hljs-string">&#x27;California&#x27;</span>, <span class="hljs-string">&#x27;California&#x27;</span>, <span class="hljs-string">&#x27;Ohio&#x27;</span>, <span class="hljs-string">&#x27;Ohio&#x27;</span>])

In [<span class="hljs-number">19</span>]: years = np.array([<span class="hljs-number">2005</span>, <span class="hljs-number">2005</span>, <span class="hljs-number">2006</span>, <span class="hljs-number">2005</span>, <span class="hljs-number">2006</span>])

In [<span class="hljs-number">20</span>]: df[<span class="hljs-string">&#x27;data1&#x27;</span>].groupby([states, years]).mean()
Out[<span class="hljs-number">20</span>]: 
California  <span class="hljs-number">2005</span>    <span class="hljs-number">0.478943</span>
            <span class="hljs-number">2006</span>   <span class="hljs-number">-0.519439</span>
Ohio        <span class="hljs-number">2005</span>   <span class="hljs-number">-0.380219</span>
            <span class="hljs-number">2006</span>    <span class="hljs-number">1.965781</span>
Name: data1, dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="14" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="14" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>通常，分组信息就位于相同的要处理DataFrame中。这里，你还可以将列名（可以是字符串、数字或其他Python对象）用作分组键：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">21</span>]: df.groupby(<span class="hljs-string">&#x27;key1&#x27;</span>).mean()
Out[<span class="hljs-number">21</span>]: 
         data1     data2
key1
a     <span class="hljs-number">0.746672</span>  <span class="hljs-number">0.910916</span>
b    <span class="hljs-number">-0.537585</span>  <span class="hljs-number">0.525384</span>

In [<span class="hljs-number">22</span>]: df.groupby([<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;key2&#x27;</span>]).mean()
Out[<span class="hljs-number">22</span>]: 
              data1     data2
key1 key2                    
a    one   <span class="hljs-number">0.880536</span>  <span class="hljs-number">1.319920</span>
     two   <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>
b    one  <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>
     two  <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="15" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="15" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>你可能已经注意到了，第一个例子在执行df.groupby('key1').mean()时，结果中没有key2列。这是因为df['key2']不是数值数据（俗称“麻烦列”），所以被从结果中排除了。默认情况下，所有数值列都会被聚合，虽然有时可能会被过滤为一个子集，稍后就会碰到。<br />
无论你准备拿groupby做什么，都有可能会用到GroupBy的size方法，它可以返回一个含有分组大小的Series：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">23</span>]: df.groupby([<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;key2&#x27;</span>]).size()
Out[<span class="hljs-number">23</span>]: 
key1  key2
a     one     <span class="hljs-number">2</span>
      two     <span class="hljs-number">1</span>
b     one     <span class="hljs-number">1</span>
      two     <span class="hljs-number">1</span>
dtype: int64 <span class="hljs-comment"># 注意，任何分组关键词中的缺失值，都会被从结果中除去。</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="16" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="16" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.1.1 对分组进行迭代</h3>
<p>GroupBy对象支持迭代，可以产生一组二元元组（由分组名和数据块组成）。看下面的例子：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">24</span>]: <span class="hljs-keyword">for</span> name, group <span class="hljs-keyword">in</span> df.groupby(<span class="hljs-string">&#x27;key1&#x27;</span>):
   ....:     print(name)
   ....:     print(group)
   ....:
a
      data1     data2 key1 key2
<span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>    a  one
<span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>    a  two
<span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>    a  one
b
      data1     data2 key1 key2
<span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one
<span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>    b  two
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="17" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="17" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>对于多重键的情况，元组的第一个元素将会是由键值组成的元组：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">25</span>]: <span class="hljs-keyword">for</span> (k1, k2), group <span class="hljs-keyword">in</span> df.groupby([<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;key2&#x27;</span>]):
   ....:     print((k1, k2))
   ....:     print(group)
   ....:
(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;one&#x27;</span>)
      data1     data2 key1 key2
<span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>    a  one
<span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>    a  one
(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;two&#x27;</span>)
      data1     data2 key1 key2
<span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>    a  two
(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;one&#x27;</span>)
      data1     data2 key1 key2
<span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one
(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;two&#x27;</span>)
     data1     data2 key1 key2
<span class="hljs-number">3</span> <span class="hljs-number">-0.55573</span>  <span class="hljs-number">0.769023</span>    b  two
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="18" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="18" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>当然，你可以对这些数据片段做任何操作。有一个你可能会觉得有用的运算：将这些数据片段做成一个字典：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">26</span>]: pieces = dict(list(df.groupby(<span class="hljs-string">&#x27;key1&#x27;</span>)))

In [<span class="hljs-number">27</span>]: pieces[<span class="hljs-string">&#x27;b&#x27;</span>]
Out[<span class="hljs-number">27</span>]: 
      data1     data2 key1 key2
<span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one
<span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>    b  two
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="19" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="19" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>groupby默认是在axis=0上进行分组的，通过设置也可以在其他任何轴上进行分组。拿上面例子中的df来说，我们可以根据dtype对列进行分组：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">28</span>]: df.dtypes
Out[<span class="hljs-number">28</span>]: 
data1    float64
data2    float64
key1      object
key2      object
dtype: object

In [<span class="hljs-number">29</span>]: grouped = df.groupby(df.dtypes, axis=<span class="hljs-number">1</span>)
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="20" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="20" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>可以如下打印分组：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">30</span>]: <span class="hljs-keyword">for</span> dtype, group <span class="hljs-keyword">in</span> grouped:
   ....:     print(dtype)
   ....:     print(group)
   ....:
float64
      data1     data2
<span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>
<span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>
<span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>
<span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>
<span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>
object
  key1 key2
<span class="hljs-number">0</span>    a  one
<span class="hljs-number">1</span>    a  two
<span class="hljs-number">2</span>    b  one
<span class="hljs-number">3</span>    b  two
<span class="hljs-number">4</span>    a  one
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="21" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="21" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.1.2 选取一列或列的子集</h3>
<p>对于由DataFrame产生的GroupBy对象，如果用一个（单个字符串）或一组（字符串数组）列名对其进行索引，就能实现选取部分列进行聚合的目的。也就是说：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>df.groupby(<span class="hljs-string">&#x27;key1&#x27;</span>)[<span class="hljs-string">&#x27;data1&#x27;</span>]
df.groupby(<span class="hljs-string">&#x27;key1&#x27;</span>)[[<span class="hljs-string">&#x27;data2&#x27;</span>]]
</span></span></foreignObject></svg></code></pre>
<p>是以下代码的语法糖：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>df[<span class="hljs-string">&#x27;data1&#x27;</span>].groupby(df[<span class="hljs-string">&#x27;key1&#x27;</span>])
df[[<span class="hljs-string">&#x27;data2&#x27;</span>]].groupby(df[<span class="hljs-string">&#x27;key1&#x27;</span>])
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="22" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="22" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>尤其对于大数据集，很可能只需要对部分列进行聚合。例如，在前面那个数据集中，如果只需计算data2列的平均值并以DataFrame形式得到结果，可以这样写：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">31</span>]: df.groupby([<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;key2&#x27;</span>])[[<span class="hljs-string">&#x27;data2&#x27;</span>]].mean()
Out[<span class="hljs-number">31</span>]: 
              data2
key1 key2          
a    one   <span class="hljs-number">1.319920</span>
     two   <span class="hljs-number">0.092908</span>
b    one   <span class="hljs-number">0.281746</span>
     two   <span class="hljs-number">0.769023</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="23" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="23" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>这种索引操作所返回的对象是一个已分组的DataFrame（如果传入的是列表或数组）或已分组的Series（如果传入的是标量形式的单个列名）：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">32</span>]: s_grouped = df.groupby([<span class="hljs-string">&#x27;key1&#x27;</span>, <span class="hljs-string">&#x27;key2&#x27;</span>])[<span class="hljs-string">&#x27;data2&#x27;</span>]

In [<span class="hljs-number">33</span>]: s_grouped
Out[<span class="hljs-number">33</span>]: &lt;pandas.core.groupby.SeriesGroupBy object at <span class="hljs-number">0x7faa30c78da0</span>&gt;

In [<span class="hljs-number">34</span>]: s_grouped.mean()
Out[<span class="hljs-number">34</span>]: 
key1  key2
a     one     <span class="hljs-number">1.319920</span>
      two     <span class="hljs-number">0.092908</span>
b     one     <span class="hljs-number">0.281746</span>
      two     <span class="hljs-number">0.769023</span>
Name: data2, dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="24" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="24" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.1.3 通过字典或Series进行分组</h3>
<p>除数组以外，分组信息还可以其他形式存在。来看另一个示例DataFrame：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">35</span>]: people = pd.DataFrame(np.random.randn(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>),
   ....:                       columns=[<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>],
   ....:                       index=[<span class="hljs-string">&#x27;Joe&#x27;</span>, <span class="hljs-string">&#x27;Steve&#x27;</span>, <span class="hljs-string">&#x27;Wes&#x27;</span>, <span class="hljs-string">&#x27;Jim&#x27;</span>, <span class="hljs-string">&#x27;Travis&#x27;</span>])

In [<span class="hljs-number">36</span>]: people.iloc[<span class="hljs-number">2</span>:<span class="hljs-number">3</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]] = np.nan <span class="hljs-comment"># Add a few NA values</span>

In [<span class="hljs-number">37</span>]: people
Out[<span class="hljs-number">37</span>]: 
               a         b         c         d         e
Joe     <span class="hljs-number">1.007189</span> <span class="hljs-number">-1.296221</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span>
Steve   <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span>
Wes    <span class="hljs-number">-0.539741</span>       NaN       NaN <span class="hljs-number">-1.021228</span> <span class="hljs-number">-0.577087</span>
Jim     <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">0.000940</span>  <span class="hljs-number">1.343810</span>
Travis <span class="hljs-number">-0.713544</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-2.370232</span> <span class="hljs-number">-1.860761</span> <span class="hljs-number">-0.860757</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="25" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="25" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>现在，假设已知列的分组关系，并希望根据分组计算列的和：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">38</span>]: mapping = {<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-string">&#x27;red&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-string">&#x27;red&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-string">&#x27;blue&#x27;</span>,
   ....:            <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-string">&#x27;blue&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>: <span class="hljs-string">&#x27;red&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span> : <span class="hljs-string">&#x27;orange&#x27;</span>}
</span></span></foreignObject></svg></code></pre>
<p>现在，你可以将这个字典传给groupby，来构造数组，但我们可以直接传递字典（我包含了键“f”来强调，存在未使用的分组键是可以的）：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">39</span>]: by_column = people.groupby(mapping, axis=<span class="hljs-number">1</span>)

In [<span class="hljs-number">40</span>]: by_column.sum()
Out[<span class="hljs-number">40</span>]: 
            blue       red
Joe     <span class="hljs-number">0.503905</span>  <span class="hljs-number">1.063885</span>
Steve   <span class="hljs-number">1.297183</span> <span class="hljs-number">-1.553778</span>
Wes    <span class="hljs-number">-1.021228</span> <span class="hljs-number">-1.116829</span>
Jim     <span class="hljs-number">0.524712</span>  <span class="hljs-number">1.770545</span>
Travis <span class="hljs-number">-4.230992</span> <span class="hljs-number">-2.405455</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="26" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="26" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>Series也有同样的功能，它可以被看做一个固定大小的映射：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">41</span>]: map_series = pd.Series(mapping)

In [<span class="hljs-number">42</span>]: map_series
Out[<span class="hljs-number">42</span>]: 
a       red
b       red
c      blue
d      blue
e       red
f    orange
dtype: object

In [<span class="hljs-number">43</span>]: people.groupby(map_series, axis=<span class="hljs-number">1</span>).count()
Out[<span class="hljs-number">43</span>]: 
        blue  red
Joe        <span class="hljs-number">2</span>    <span class="hljs-number">3</span>
Steve      <span class="hljs-number">2</span>    <span class="hljs-number">3</span>
Wes        <span class="hljs-number">1</span>    <span class="hljs-number">2</span>
Jim        <span class="hljs-number">2</span>    <span class="hljs-number">3</span>
Travis     <span class="hljs-number">2</span>    <span class="hljs-number">3</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="27" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="27" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.1.4 通过函数进行分组</h3>
<p>比起使用字典或Series，使用Python函数是一种更原生的方法定义分组映射。任何被当做分组键的函数都会在各个索引值上被调用一次，其返回值就会被用作分组名称。具体点说，以上一小节的示例DataFrame为例，其索引值为人的名字。你可以计算一个字符串长度的数组，更简单的方法是传入len函数：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">44</span>]: people.groupby(len).sum()
Out[<span class="hljs-number">44</span>]: 
          a         b         c         d         e
<span class="hljs-number">3</span>  <span class="hljs-number">0.591569</span> <span class="hljs-number">-0.993608</span>  <span class="hljs-number">0.798764</span> <span class="hljs-number">-0.791374</span>  <span class="hljs-number">2.119639</span>
<span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span>
<span class="hljs-number">6</span> <span class="hljs-number">-0.713544</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-2.370232</span> <span class="hljs-number">-1.860761</span> <span class="hljs-number">-0.860757</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="28" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="28" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>将函数跟数组、列表、字典、Series混合使用也不是问题，因为任何东西在内部都会被转换为数组：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">45</span>]: key_list = [<span class="hljs-string">&#x27;one&#x27;</span>, <span class="hljs-string">&#x27;one&#x27;</span>, <span class="hljs-string">&#x27;one&#x27;</span>, <span class="hljs-string">&#x27;two&#x27;</span>, <span class="hljs-string">&#x27;two&#x27;</span>]

In [<span class="hljs-number">46</span>]: people.groupby([len, key_list]).min()
Out[<span class="hljs-number">46</span>]: 
              a         b         c         d         e
<span class="hljs-number">3</span> one <span class="hljs-number">-0.539741</span> <span class="hljs-number">-1.296221</span>  <span class="hljs-number">0.274992</span> <span class="hljs-number">-1.021228</span> <span class="hljs-number">-0.577087</span>
  two  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">0.000940</span>  <span class="hljs-number">1.343810</span>
<span class="hljs-number">5</span> one  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span>
<span class="hljs-number">6</span> two <span class="hljs-number">-0.713544</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-2.370232</span> <span class="hljs-number">-1.860761</span> <span class="hljs-number">-0.860757</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="29" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="29" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.1.5 根据索引级别分组</h3>
<p>层次化索引数据集最方便的地方就在于它能够根据轴索引的一个级别进行聚合：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">47</span>]: columns = pd.MultiIndex.from_arrays([[<span class="hljs-string">&#x27;US&#x27;</span>, <span class="hljs-string">&#x27;US&#x27;</span>, <span class="hljs-string">&#x27;US&#x27;</span>, <span class="hljs-string">&#x27;JP&#x27;</span>, <span class="hljs-string">&#x27;JP&#x27;</span>],
   ....:                                     [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>]],
   ....:                                     names=[<span class="hljs-string">&#x27;cty&#x27;</span>, <span class="hljs-string">&#x27;tenor&#x27;</span>])

In [<span class="hljs-number">48</span>]: hier_df = pd.DataFrame(np.random.randn(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>), columns=columns)

In [<span class="hljs-number">49</span>]: hier_df
Out[<span class="hljs-number">49</span>]: 
cty          US                            JP          
tenor         <span class="hljs-number">1</span>         <span class="hljs-number">3</span>         <span class="hljs-number">5</span>         <span class="hljs-number">1</span>         <span class="hljs-number">3</span>
<span class="hljs-number">0</span>      <span class="hljs-number">0.560145</span> <span class="hljs-number">-1.265934</span>  <span class="hljs-number">0.119827</span> <span class="hljs-number">-1.063512</span>  <span class="hljs-number">0.332883</span>
<span class="hljs-number">1</span>     <span class="hljs-number">-2.359419</span> <span class="hljs-number">-0.199543</span> <span class="hljs-number">-1.541996</span> <span class="hljs-number">-0.970736</span> <span class="hljs-number">-1.307030</span>
<span class="hljs-number">2</span>      <span class="hljs-number">0.286350</span>  <span class="hljs-number">0.377984</span> <span class="hljs-number">-0.753887</span>  <span class="hljs-number">0.331286</span>  <span class="hljs-number">1.349742</span>
<span class="hljs-number">3</span>      <span class="hljs-number">0.069877</span>  <span class="hljs-number">0.246674</span> <span class="hljs-number">-0.011862</span>  <span class="hljs-number">1.004812</span>  <span class="hljs-number">1.327195</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="30" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="30" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>要根据级别分组，使用level关键字传递级别序号或名字：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">50</span>]: hier_df.groupby(level=<span class="hljs-string">&#x27;cty&#x27;</span>, axis=<span class="hljs-number">1</span>).count()
Out[<span class="hljs-number">50</span>]: 
cty  JP  US
<span class="hljs-number">0</span>     <span class="hljs-number">2</span>   <span class="hljs-number">3</span>
<span class="hljs-number">1</span>     <span class="hljs-number">2</span>   <span class="hljs-number">3</span>
<span class="hljs-number">2</span>     <span class="hljs-number">2</span>   <span class="hljs-number">3</span>
<span class="hljs-number">3</span>     <span class="hljs-number">2</span>   <span class="hljs-number">3</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="31" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="31" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h2>10.2 数据聚合</h2>
<p>聚合指的是任何能够从数组产生标量值的数据转换过程。之前的例子已经用过一些，比如mean、count、min以及sum等。你可能想知道在GroupBy对象上调用mean()时究竟发生了什么。许多常见的聚合运算（如表10-1所示）都有进行优化。然而，除了这些方法，你还可以使用其它的。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/7178691-ba8de524e08b1b6f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="表10-1 经过优化的groupby方法" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="32" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="32" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>你可以使用自己发明的聚合运算，还可以调用分组对象上已经定义好的任何方法。例如，quantile可以计算Series或DataFrame列的样本分位数。</p>
<p>虽然quantile并没有明确地实现于GroupBy，但它是一个Series方法，所以这里是能用的。实际上，GroupBy会高效地对Series进行切片，然后对各片调用piece.quantile(0.9)，最后将这些结果组装成最终结果：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="33" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="33" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">51</span>]: df
Out[<span class="hljs-number">51</span>]: 
      data1     data2 key1 key2
<span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>    a  one
<span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>    a  two
<span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one
<span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>    b  two
<span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>    a  one

In [<span class="hljs-number">52</span>]: grouped = df.groupby(<span class="hljs-string">&#x27;key1&#x27;</span>)

In [<span class="hljs-number">53</span>]: grouped[<span class="hljs-string">&#x27;data1&#x27;</span>].quantile(<span class="hljs-number">0.9</span>)
Out[<span class="hljs-number">53</span>]: 
key1
a    <span class="hljs-number">1.668413</span>
b   <span class="hljs-number">-0.523068</span>
Name: data1, dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="34" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="34" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>如果要使用你自己的聚合函数，只需将其传入aggregate或agg方法即可：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">54</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">peak_to_peak</span>(<span class="hljs-params">arr</span>):</span>
   ....:     <span class="hljs-keyword">return</span> arr.max() - arr.min()
In [<span class="hljs-number">55</span>]: grouped.agg(peak_to_peak)
Out[<span class="hljs-number">55</span>]: 
         data1     data2
key1                    
a     <span class="hljs-number">2.170488</span>  <span class="hljs-number">1.300498</span>
b     <span class="hljs-number">0.036292</span>  <span class="hljs-number">0.487276</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="35" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="35" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>你可能注意到注意，有些方法（如describe）也是可以用在这里的，即使严格来讲，它们并非聚合运算：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">56</span>]: grouped.describe()
Out[<span class="hljs-number">56</span>]: 
     data1                                                              \
     count      mean       std       min       <span class="hljs-number">25</span>%       <span class="hljs-number">50</span>%       <span class="hljs-number">75</span>%   
key1                                                                     
a      <span class="hljs-number">3.0</span>  <span class="hljs-number">0.746672</span>  <span class="hljs-number">1.109736</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.137118</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">1.222362</span>   
b      <span class="hljs-number">2.0</span> <span class="hljs-number">-0.537585</span>  <span class="hljs-number">0.025662</span> <span class="hljs-number">-0.555730</span> <span class="hljs-number">-0.546657</span> <span class="hljs-number">-0.537585</span> <span class="hljs-number">-0.528512</span>   
               data2                                                    \
max count      mean       std       min       <span class="hljs-number">25</span>%       <span class="hljs-number">50</span>%   
key1                                                                     
a     <span class="hljs-number">1.965781</span>   <span class="hljs-number">3.0</span>  <span class="hljs-number">0.910916</span>  <span class="hljs-number">0.712217</span>  <span class="hljs-number">0.092908</span>  <span class="hljs-number">0.669671</span>  <span class="hljs-number">1.246435</span>   
b    <span class="hljs-number">-0.519439</span>   <span class="hljs-number">2.0</span>  <span class="hljs-number">0.525384</span>  <span class="hljs-number">0.344556</span>  <span class="hljs-number">0.281746</span>  <span class="hljs-number">0.403565</span>  <span class="hljs-number">0.525384</span>   
                          
           <span class="hljs-number">75</span>%       max  
key1                      
a     <span class="hljs-number">1.319920</span>  <span class="hljs-number">1.393406</span>  
b     <span class="hljs-number">0.647203</span>  <span class="hljs-number">0.769023</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="36" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="36" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>在后面的10.3节，我将详细说明这到底是怎么回事。</p>
<blockquote>
<p>笔记：自定义聚合函数要比表10-1中那些经过优化的函数慢得多。这是因为在构造中间分组数据块时存在非常大的开销（函数调用、数据重排等）。</p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="37" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="37" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.2.1 面向列的多函数应用</h3>
<p>回到前面小费的例子。使用read_csv导入数据之后，我们添加了一个小费百分比的列tip_pct：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="38" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="38" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">57</span>]: tips = pd.read_csv(<span class="hljs-string">&#x27;examples/tips.csv&#x27;</span>)

<span class="hljs-comment"># Add tip percentage of total bill</span>
In [<span class="hljs-number">58</span>]: tips[<span class="hljs-string">&#x27;tip_pct&#x27;</span>] = tips[<span class="hljs-string">&#x27;tip&#x27;</span>] / tips[<span class="hljs-string">&#x27;total_bill&#x27;</span>]

In [<span class="hljs-number">59</span>]: tips[:<span class="hljs-number">6</span>]
Out[<span class="hljs-number">59</span>]: 
   total_bill   tip smoker  day    time  size   tip_pct
<span class="hljs-number">0</span>       <span class="hljs-number">16.99</span>  <span class="hljs-number">1.01</span>     No  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.059447</span>
<span class="hljs-number">1</span>       <span class="hljs-number">10.34</span>  <span class="hljs-number">1.66</span>     No  Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.160542</span>
<span class="hljs-number">2</span>       <span class="hljs-number">21.01</span>  <span class="hljs-number">3.50</span>     No  Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.166587</span>
<span class="hljs-number">3</span>       <span class="hljs-number">23.68</span>  <span class="hljs-number">3.31</span>     No  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.139780</span>
<span class="hljs-number">4</span>       <span class="hljs-number">24.59</span>  <span class="hljs-number">3.61</span>     No  Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.146808</span>
<span class="hljs-number">5</span>       <span class="hljs-number">25.29</span>  <span class="hljs-number">4.71</span>     No  Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.186240</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="39" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="39" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>你已经看到，对Series或DataFrame列的聚合运算其实就是使用aggregate（使用自定义函数）或调用诸如mean、std之类的方法。然而，你可能希望对不同的列使用不同的聚合函数，或一次应用多个函数。其实这也好办，我将通过一些示例来进行讲解。首先，我根据天和smoker对tips进行分组：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">60</span>]: grouped = tips.groupby([<span class="hljs-string">&#x27;day&#x27;</span>, <span class="hljs-string">&#x27;smoker&#x27;</span>])
</span></span></foreignObject></svg></code></pre>
<p>注意，对于表10-1中的那些描述统计，可以将函数名以字符串的形式传入：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="40" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="40" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">61</span>]: grouped_pct = grouped[<span class="hljs-string">&#x27;tip_pct&#x27;</span>]

In [<span class="hljs-number">62</span>]: grouped_pct.agg(<span class="hljs-string">&#x27;mean&#x27;</span>)
Out[<span class="hljs-number">62</span>]: 
day   smoker
Fri   No        <span class="hljs-number">0.151650</span>
      Yes       <span class="hljs-number">0.174783</span>
Sat   No        <span class="hljs-number">0.158048</span>
      Yes       <span class="hljs-number">0.147906</span>
Sun   No        <span class="hljs-number">0.160113</span>
      Yes       <span class="hljs-number">0.187250</span>
Thur  No        <span class="hljs-number">0.160298</span>
      Yes       <span class="hljs-number">0.163863</span>
Name: tip_pct, dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="41" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="41" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>如果传入一组函数或函数名，得到的DataFrame的列就会以相应的函数命名：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">63</span>]: grouped_pct.agg([<span class="hljs-string">&#x27;mean&#x27;</span>, <span class="hljs-string">&#x27;std&#x27;</span>, peak_to_peak])
Out[<span class="hljs-number">63</span>]: 
                 mean       std  peak_to_peak
day  smoker                                  
Fri  No      <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.028123</span>      <span class="hljs-number">0.067349</span>
     Yes     <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.051293</span>      <span class="hljs-number">0.159925</span>
Sat  No      <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.039767</span>      <span class="hljs-number">0.235193</span>
     Yes     <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.061375</span>      <span class="hljs-number">0.290095</span>
Sun  No      <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.042347</span>      <span class="hljs-number">0.193226</span>
     Yes     <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.154134</span>      <span class="hljs-number">0.644685</span>
Thur No      <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.038774</span>      <span class="hljs-number">0.193350</span>
     Yes     <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.039389</span>      <span class="hljs-number">0.151240</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="42" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="42" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>这里，我们传递了一组聚合函数进行聚合，独立对数据分组进行评估。</p>
<p>你并非一定要接受GroupBy自动给出的那些列名，特别是lambda函数，它们的名称是'&lt;lambda&gt;'，这样的辨识度就很低了（通过函数的__name__属性看看就知道了）。因此，如果传入的是一个由(name,function)元组组成的列表，则各元组的第一个元素就会被用作DataFrame的列名（可以将这种二元元组列表看做一个有序映射）：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="43" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="43" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">64</span>]: grouped_pct.agg([(<span class="hljs-string">&#x27;foo&#x27;</span>, <span class="hljs-string">&#x27;mean&#x27;</span>), (<span class="hljs-string">&#x27;bar&#x27;</span>, np.std)])
Out[<span class="hljs-number">64</span>]: 
                  foo       bar
day  smoker                    
Fri  No      <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.028123</span>
     Yes     <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.051293</span>
Sat  No      <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.039767</span>
     Yes     <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.061375</span>
Sun  No      <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.042347</span>
     Yes     <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.154134</span>
Thur No      <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.038774</span>
     Yes     <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.039389</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="44" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="44" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>对于DataFrame，你还有更多选择，你可以定义一组应用于全部列的一组函数，或不同的列应用不同的函数。假设我们想要对tip_pct和total_bill列计算三个统计信息：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="45" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="45" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">65</span>]: functions = [<span class="hljs-string">&#x27;count&#x27;</span>, <span class="hljs-string">&#x27;mean&#x27;</span>, <span class="hljs-string">&#x27;max&#x27;</span>]

In [<span class="hljs-number">66</span>]: result = grouped[<span class="hljs-string">&#x27;tip_pct&#x27;</span>, <span class="hljs-string">&#x27;total_bill&#x27;</span>].agg(functions)

In [<span class="hljs-number">67</span>]: result
Out[<span class="hljs-number">67</span>]: 
            tip_pct                     total_bill                  
              count      mean       max      count       mean    max
day  smoker                                                         
Fri  No           <span class="hljs-number">4</span>  <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.187735</span>          <span class="hljs-number">4</span>  <span class="hljs-number">18.420000</span>  <span class="hljs-number">22.75</span>
     Yes         <span class="hljs-number">15</span>  <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.263480</span>         <span class="hljs-number">15</span>  <span class="hljs-number">16.813333</span>  <span class="hljs-number">40.17</span>
Sat  No          <span class="hljs-number">45</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.291990</span>         <span class="hljs-number">45</span>  <span class="hljs-number">19.661778</span>  <span class="hljs-number">48.33</span>
     Yes         <span class="hljs-number">42</span>  <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.325733</span>         <span class="hljs-number">42</span>  <span class="hljs-number">21.276667</span>  <span class="hljs-number">50.81</span>
Sun  No          <span class="hljs-number">57</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.252672</span>         <span class="hljs-number">57</span>  <span class="hljs-number">20.506667</span>  <span class="hljs-number">48.17</span>
     Yes         <span class="hljs-number">19</span>  <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.710345</span>         <span class="hljs-number">19</span>  <span class="hljs-number">24.120000</span>  <span class="hljs-number">45.35</span>
Thur No          <span class="hljs-number">45</span>  <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.266312</span>         <span class="hljs-number">45</span>  <span class="hljs-number">17.113111</span>  <span class="hljs-number">41.19</span>
     Yes         <span class="hljs-number">17</span>  <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.241255</span>         <span class="hljs-number">17</span>  <span class="hljs-number">19.190588</span>  <span class="hljs-number">43.11</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="46" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="46" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>如你所见，结果DataFrame拥有层次化的列，这相当于分别对各列进行聚合，然后用concat将结果组装到一起，使用列名用作keys参数：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">68</span>]: result[<span class="hljs-string">&#x27;tip_pct&#x27;</span>]
Out[<span class="hljs-number">68</span>]: 
             count      mean       max
day  smoker                           
Fri  No          <span class="hljs-number">4</span>  <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.187735</span>
     Yes        <span class="hljs-number">15</span>  <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.263480</span>
Sat  No         <span class="hljs-number">45</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.291990</span>
     Yes        <span class="hljs-number">42</span>  <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.325733</span>
Sun  No         <span class="hljs-number">57</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.252672</span>
     Yes        <span class="hljs-number">19</span>  <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.710345</span>
Thur No         <span class="hljs-number">45</span>  <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.266312</span>
     Yes        <span class="hljs-number">17</span>  <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.241255</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="47" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="47" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>跟前面一样，这里也可以传入带有自定义名称的一组元组：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">69</span>]: ftuples = [(<span class="hljs-string">&#x27;Durchschnitt&#x27;</span>, <span class="hljs-string">&#x27;mean&#x27;</span>),(<span class="hljs-string">&#x27;Abweichung&#x27;</span>, np.var)]

In [<span class="hljs-number">70</span>]: grouped[<span class="hljs-string">&#x27;tip_pct&#x27;</span>, <span class="hljs-string">&#x27;total_bill&#x27;</span>].agg(ftuples)
Out[<span class="hljs-number">70</span>]: 
                 tip_pct              total_bill            
            Durchschnitt Abweichung Durchschnitt  Abweichung
day  smoker                                                 
Fri  No         <span class="hljs-number">0.151650</span>   <span class="hljs-number">0.000791</span>    <span class="hljs-number">18.420000</span>   <span class="hljs-number">25.596333</span>
     Yes        <span class="hljs-number">0.174783</span>   <span class="hljs-number">0.002631</span>    <span class="hljs-number">16.813333</span>   <span class="hljs-number">82.562438</span>
Sat  No         <span class="hljs-number">0.158048</span>   <span class="hljs-number">0.001581</span>    <span class="hljs-number">19.661778</span>   <span class="hljs-number">79.908965</span>
     Yes        <span class="hljs-number">0.147906</span>   <span class="hljs-number">0.003767</span>    <span class="hljs-number">21.276667</span>  <span class="hljs-number">101.387535</span>
Sun  No         <span class="hljs-number">0.160113</span>   <span class="hljs-number">0.001793</span>    <span class="hljs-number">20.506667</span>   <span class="hljs-number">66.099980</span>
     Yes        <span class="hljs-number">0.187250</span>   <span class="hljs-number">0.023757</span>    <span class="hljs-number">24.120000</span>  <span class="hljs-number">109.046044</span>
Thur No         <span class="hljs-number">0.160298</span>   <span class="hljs-number">0.001503</span>    <span class="hljs-number">17.113111</span>   <span class="hljs-number">59.625081</span>
     Yes        <span class="hljs-number">0.163863</span>   <span class="hljs-number">0.001551</span>    <span class="hljs-number">19.190588</span>   <span class="hljs-number">69.808518</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="48" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="48" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>现在，假设你想要对一个列或不同的列应用不同的函数。具体的办法是向agg传入一个从列名映射到函数的字典：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="49" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="49" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">71</span>]: grouped.agg({<span class="hljs-string">&#x27;tip&#x27;</span> : np.max, <span class="hljs-string">&#x27;size&#x27;</span> : <span class="hljs-string">&#x27;sum&#x27;</span>})
Out[<span class="hljs-number">71</span>]: 
               tip  size
day  smoker             
Fri  No       <span class="hljs-number">3.50</span>     <span class="hljs-number">9</span>
     Yes      <span class="hljs-number">4.73</span>    <span class="hljs-number">31</span>
Sat  No       <span class="hljs-number">9.00</span>   <span class="hljs-number">115</span>
     Yes     <span class="hljs-number">10.00</span>   <span class="hljs-number">104</span>
Sun  No       <span class="hljs-number">6.00</span>   <span class="hljs-number">167</span>
     Yes      <span class="hljs-number">6.50</span>    <span class="hljs-number">49</span>
Thur No       <span class="hljs-number">6.70</span>   <span class="hljs-number">112</span>
     Yes      <span class="hljs-number">5.00</span>    <span class="hljs-number">40</span>
In [<span class="hljs-number">72</span>]: grouped.agg({<span class="hljs-string">&#x27;tip_pct&#x27;</span> : [<span class="hljs-string">&#x27;min&#x27;</span>, <span class="hljs-string">&#x27;max&#x27;</span>, <span class="hljs-string">&#x27;mean&#x27;</span>, <span class="hljs-string">&#x27;std&#x27;</span>],
   ....:              <span class="hljs-string">&#x27;size&#x27;</span> : <span class="hljs-string">&#x27;sum&#x27;</span>})
Out[<span class="hljs-number">72</span>]: 
              tip_pct                               size
                  min       max      mean       std  sum
day  smoker                                             
Fri  No      <span class="hljs-number">0.120385</span>  <span class="hljs-number">0.187735</span>  <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.028123</span>    <span class="hljs-number">9</span>
     Yes     <span class="hljs-number">0.103555</span>  <span class="hljs-number">0.263480</span>  <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.051293</span>   <span class="hljs-number">31</span>
Sat  No      <span class="hljs-number">0.056797</span>  <span class="hljs-number">0.291990</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.039767</span>  <span class="hljs-number">115</span>
     Yes     <span class="hljs-number">0.035638</span>  <span class="hljs-number">0.325733</span>  <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.061375</span>  <span class="hljs-number">104</span>
Sun  No      <span class="hljs-number">0.059447</span>  <span class="hljs-number">0.252672</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.042347</span>  <span class="hljs-number">167</span>
     Yes     <span class="hljs-number">0.065660</span>  <span class="hljs-number">0.710345</span>  <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.154134</span>   <span class="hljs-number">49</span>
Thur No      <span class="hljs-number">0.072961</span>  <span class="hljs-number">0.266312</span>  <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.038774</span>  <span class="hljs-number">112</span>
     Yes     <span class="hljs-number">0.090014</span>  <span class="hljs-number">0.241255</span>  <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.039389</span>   <span class="hljs-number">40</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="50" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="50" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>只有将多个函数应用到至少一列时，DataFrame才会拥有层次化的列。</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="51" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="51" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.2.2 以“没有行索引”的形式返回聚合数据</h3>
<p>到目前为止，所有示例中的聚合数据都有由唯一的分组键组成的索引（可能还是层次化的）。由于并不总是需要如此，所以你可以向groupby传入as_index=False以禁用该功能：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">73</span>]: tips.groupby([<span class="hljs-string">&#x27;day&#x27;</span>, <span class="hljs-string">&#x27;smoker&#x27;</span>], as_index=<span class="hljs-literal">False</span>).mean()
Out[<span class="hljs-number">73</span>]: 
    day smoker  total_bill       tip      size   tip_pct
<span class="hljs-number">0</span>   Fri     No   <span class="hljs-number">18.420000</span>  <span class="hljs-number">2.812500</span>  <span class="hljs-number">2.250000</span>  <span class="hljs-number">0.151650</span>
<span class="hljs-number">1</span>   Fri    Yes   <span class="hljs-number">16.813333</span>  <span class="hljs-number">2.714000</span>  <span class="hljs-number">2.066667</span>  <span class="hljs-number">0.174783</span>
<span class="hljs-number">2</span>   Sat     No   <span class="hljs-number">19.661778</span>  <span class="hljs-number">3.102889</span>  <span class="hljs-number">2.555556</span>  <span class="hljs-number">0.158048</span>
<span class="hljs-number">3</span>   Sat    Yes   <span class="hljs-number">21.276667</span>  <span class="hljs-number">2.875476</span>  <span class="hljs-number">2.476190</span>  <span class="hljs-number">0.147906</span>
<span class="hljs-number">4</span>   Sun     No   <span class="hljs-number">20.506667</span>  <span class="hljs-number">3.167895</span>  <span class="hljs-number">2.929825</span>  <span class="hljs-number">0.160113</span>
<span class="hljs-number">5</span>   Sun    Yes   <span class="hljs-number">24.120000</span>  <span class="hljs-number">3.516842</span>  <span class="hljs-number">2.578947</span>  <span class="hljs-number">0.187250</span>
<span class="hljs-number">6</span>  Thur     No   <span class="hljs-number">17.113111</span>  <span class="hljs-number">2.673778</span>  <span class="hljs-number">2.488889</span>  <span class="hljs-number">0.160298</span>
<span class="hljs-number">7</span>  Thur    Yes   <span class="hljs-number">19.190588</span>  <span class="hljs-number">3.030000</span>  <span class="hljs-number">2.352941</span>  <span class="hljs-number">0.163863</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="52" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="52" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>当然，对结果调用reset_index也能得到这种形式的结果。使用as_index=False方法可以避免一些不必要的计算。</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="53" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="53" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h2>10.3 应用(apply)：一般性的“拆分－应用－合并”</h2>
<p>最通用的GroupBy方法是apply，本节剩余部分将重点讲解它。如图10-2所示，apply会将待处理的对象拆分成多个片段，然后对各片段调用传入的函数，最后尝试将各片段组合到一起。</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="54" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="54" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p><img src="http://upload-images.jianshu.io/upload_images/7178691-7e8bb217f599b4ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图10-2 分组聚合示例 w:700" style="width:700px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="55" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="55" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>回到之前那个小费数据集，假设你想要根据分组选出最高的5个tip_pct值。首先，编写一个选取指定列具有最大值的行的函数：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">74</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">top</span>(<span class="hljs-params">df, n=<span class="hljs-number">5</span>, column=<span class="hljs-string">&#x27;tip_pct&#x27;</span></span>):</span>
   ....:     <span class="hljs-keyword">return</span> df.sort_values(by=column)[-n:]

In [<span class="hljs-number">75</span>]: top(tips, n=<span class="hljs-number">6</span>)
Out[<span class="hljs-number">75</span>]: 
     total_bill   tip smoker  day    time  size   tip_pct
<span class="hljs-number">109</span>       <span class="hljs-number">14.31</span>  <span class="hljs-number">4.00</span>    Yes  Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.279525</span>
<span class="hljs-number">183</span>       <span class="hljs-number">23.17</span>  <span class="hljs-number">6.50</span>    Yes  Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.280535</span>
<span class="hljs-number">232</span>       <span class="hljs-number">11.61</span>  <span class="hljs-number">3.39</span>     No  Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.291990</span>
<span class="hljs-number">67</span>         <span class="hljs-number">3.07</span>  <span class="hljs-number">1.00</span>    Yes  Sat  Dinner     <span class="hljs-number">1</span>  <span class="hljs-number">0.325733</span>
<span class="hljs-number">178</span>        <span class="hljs-number">9.60</span>  <span class="hljs-number">4.00</span>    Yes  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.416667</span>
<span class="hljs-number">172</span>        <span class="hljs-number">7.25</span>  <span class="hljs-number">5.15</span>    Yes  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.710345</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="56" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="56" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>现在，如果对smoker分组并用该函数调用apply，就会得到：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">76</span>]: tips.groupby(<span class="hljs-string">&#x27;smoker&#x27;</span>).apply(top)
Out[<span class="hljs-number">76</span>]: 
            total_bill   tip smoker   day    time  size   tip_pct
smoker                                                           
No     <span class="hljs-number">88</span>        <span class="hljs-number">24.71</span>  <span class="hljs-number">5.85</span>     No  Thur   Lunch     <span class="hljs-number">2</span>  <span class="hljs-number">0.236746</span>
       <span class="hljs-number">185</span>       <span class="hljs-number">20.69</span>  <span class="hljs-number">5.00</span>     No   Sun  Dinner     <span class="hljs-number">5</span>  <span class="hljs-number">0.241663</span>
       <span class="hljs-number">51</span>        <span class="hljs-number">10.29</span>  <span class="hljs-number">2.60</span>     No   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.252672</span>
       <span class="hljs-number">149</span>        <span class="hljs-number">7.51</span>  <span class="hljs-number">2.00</span>     No  Thur   Lunch     <span class="hljs-number">2</span>  <span class="hljs-number">0.266312</span>
       <span class="hljs-number">232</span>       <span class="hljs-number">11.61</span>  <span class="hljs-number">3.39</span>     No   Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.291990</span>
Yes    <span class="hljs-number">109</span>       <span class="hljs-number">14.31</span>  <span class="hljs-number">4.00</span>    Yes   Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.279525</span>
       <span class="hljs-number">183</span>       <span class="hljs-number">23.17</span>  <span class="hljs-number">6.50</span>    Yes   Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.280535</span>
       <span class="hljs-number">67</span>         <span class="hljs-number">3.07</span>  <span class="hljs-number">1.00</span>    Yes   Sat  Dinner     <span class="hljs-number">1</span>  <span class="hljs-number">0.325733</span>
       <span class="hljs-number">178</span>        <span class="hljs-number">9.60</span>  <span class="hljs-number">4.00</span>    Yes   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.416667</span>
       <span class="hljs-number">172</span>        <span class="hljs-number">7.25</span>  <span class="hljs-number">5.15</span>    Yes   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.710345</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="57" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="57" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>这里发生了什么？top函数在DataFrame的各个片段上调用，然后结果由pandas.concat组装到一起，并以分组名称进行了标记。于是，最终结果就有了一个层次化索引，其内层索引值来自原DataFrame。</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="58" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="58" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>如果传给apply的函数能够接受其他参数或关键字，则可以将这些内容放在函数名后面一并传入：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">77</span>]: tips.groupby([<span class="hljs-string">&#x27;smoker&#x27;</span>, <span class="hljs-string">&#x27;day&#x27;</span>]).apply(top, n=<span class="hljs-number">1</span>, column=<span class="hljs-string">&#x27;total_bill&#x27;</span>)
Out[<span class="hljs-number">77</span>]: 
                 total_bill    tip smoker   day    time  size   tip_pct
smoker day                                                             
No     Fri  <span class="hljs-number">94</span>        <span class="hljs-number">22.75</span>   <span class="hljs-number">3.25</span>     No   Fri  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.142857</span>
       Sat  <span class="hljs-number">212</span>       <span class="hljs-number">48.33</span>   <span class="hljs-number">9.00</span>     No   Sat  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.186220</span>
       Sun  <span class="hljs-number">156</span>       <span class="hljs-number">48.17</span>   <span class="hljs-number">5.00</span>     No   Sun  Dinner     <span class="hljs-number">6</span>  <span class="hljs-number">0.103799</span>
       Thur <span class="hljs-number">142</span>       <span class="hljs-number">41.19</span>   <span class="hljs-number">5.00</span>     No  Thur   Lunch     <span class="hljs-number">5</span>  <span class="hljs-number">0.121389</span>
Yes    Fri  <span class="hljs-number">95</span>        <span class="hljs-number">40.17</span>   <span class="hljs-number">4.73</span>    Yes   Fri  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.117750</span>
       Sat  <span class="hljs-number">170</span>       <span class="hljs-number">50.81</span>  <span class="hljs-number">10.00</span>    Yes   Sat  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.196812</span>
       Sun  <span class="hljs-number">182</span>       <span class="hljs-number">45.35</span>   <span class="hljs-number">3.50</span>    Yes   Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.077178</span>
       Thur <span class="hljs-number">197</span>       <span class="hljs-number">43.11</span>   <span class="hljs-number">5.00</span>    Yes  Thur   Lunch     <span class="hljs-number">4</span>  <span class="hljs-number">0.115982</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="59" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="59" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<blockquote>
<p>笔记：除这些基本用法之外，能否充分发挥apply的威力很大程度上取决于你的创造力。传入的那个函数能做什么全由你说了算，它只需返回一个pandas对象或标量值即可。本章后续部分的示例主要用于讲解如何利用groupby解决各种各样的问题。</p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="60" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="60" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>可能你已经想起来了，之前我在GroupBy对象上调用过describe：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">78</span>]: result = tips.groupby(<span class="hljs-string">&#x27;smoker&#x27;</span>)[<span class="hljs-string">&#x27;tip_pct&#x27;</span>].describe()

In [<span class="hljs-number">79</span>]: result
Out[<span class="hljs-number">79</span>]: 
        count      mean       std       min       <span class="hljs-number">25</span>%       <span class="hljs-number">50</span>%       <span class="hljs-number">75</span>%  \
smoker                                                                      
No      <span class="hljs-number">151.0</span>  <span class="hljs-number">0.159328</span>  <span class="hljs-number">0.039910</span>  <span class="hljs-number">0.056797</span>  <span class="hljs-number">0.136906</span>  <span class="hljs-number">0.155625</span>  <span class="hljs-number">0.185014</span>   
Yes      <span class="hljs-number">93.0</span>  <span class="hljs-number">0.163196</span>  <span class="hljs-number">0.085119</span>  <span class="hljs-number">0.035638</span>  <span class="hljs-number">0.106771</span>  <span class="hljs-number">0.153846</span>  <span class="hljs-number">0.195059</span>   
             max  
smoker

No      <span class="hljs-number">0.291990</span>  
Yes     <span class="hljs-number">0.710345</span>  

In [<span class="hljs-number">80</span>]: result.unstack(<span class="hljs-string">&#x27;smoker&#x27;</span>)
Out[<span class="hljs-number">80</span>]: 
       smoker
count  No        <span class="hljs-number">151.000000</span>
       Yes        <span class="hljs-number">93.000000</span>
mean   No          <span class="hljs-number">0.159328</span>
       Yes         <span class="hljs-number">0.163196</span>
std    No          <span class="hljs-number">0.039910</span>
       Yes         <span class="hljs-number">0.085119</span>
min    No          <span class="hljs-number">0.056797</span>
       Yes         <span class="hljs-number">0.035638</span>
<span class="hljs-number">25</span>%    No          <span class="hljs-number">0.136906</span>
       Yes         <span class="hljs-number">0.106771</span>
<span class="hljs-number">50</span>%    No          <span class="hljs-number">0.155625</span>
       Yes         <span class="hljs-number">0.153846</span>
<span class="hljs-number">75</span>%    No          <span class="hljs-number">0.185014</span>
       Yes         <span class="hljs-number">0.195059</span>
max    No          <span class="hljs-number">0.291990</span>
       Yes         <span class="hljs-number">0.710345</span>
dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="61" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="61" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>在GroupBy中，当你调用诸如describe之类的方法时，实际上只是应用了下面两条代码的快捷方式而已：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>f = <span class="hljs-keyword">lambda</span> x: x.describe()
grouped.apply(f)
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="62" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="62" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.3.1 禁止分组键</h3>
<p>从上面的例子中可以看出，分组键会跟原始对象的索引共同构成结果对象中的层次化索引。将group_keys=False传入groupby即可禁止该效果：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">81</span>]: tips.groupby(<span class="hljs-string">&#x27;smoker&#x27;</span>, group_keys=<span class="hljs-literal">False</span>).apply(top)
Out[<span class="hljs-number">81</span>]: 
     total_bill   tip smoker   day    time  size   tip_pct
<span class="hljs-number">88</span>        <span class="hljs-number">24.71</span>  <span class="hljs-number">5.85</span>     No  Thur   Lunch     <span class="hljs-number">2</span>  <span class="hljs-number">0.236746</span>
<span class="hljs-number">185</span>       <span class="hljs-number">20.69</span>  <span class="hljs-number">5.00</span>     No   Sun  Dinner     <span class="hljs-number">5</span>  <span class="hljs-number">0.241663</span>
<span class="hljs-number">51</span>        <span class="hljs-number">10.29</span>  <span class="hljs-number">2.60</span>     No   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.252672</span>
<span class="hljs-number">149</span>        <span class="hljs-number">7.51</span>  <span class="hljs-number">2.00</span>     No  Thur   Lunch     <span class="hljs-number">2</span>  <span class="hljs-number">0.266312</span>
<span class="hljs-number">232</span>       <span class="hljs-number">11.61</span>  <span class="hljs-number">3.39</span>     No   Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.291990</span>
<span class="hljs-number">109</span>       <span class="hljs-number">14.31</span>  <span class="hljs-number">4.00</span>    Yes   Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.279525</span>
<span class="hljs-number">183</span>       <span class="hljs-number">23.17</span>  <span class="hljs-number">6.50</span>    Yes   Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.280535</span>
<span class="hljs-number">67</span>         <span class="hljs-number">3.07</span>  <span class="hljs-number">1.00</span>    Yes   Sat  Dinner     <span class="hljs-number">1</span>  <span class="hljs-number">0.325733</span>
<span class="hljs-number">178</span>        <span class="hljs-number">9.60</span>  <span class="hljs-number">4.00</span>    Yes   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.416667</span>
<span class="hljs-number">172</span>        <span class="hljs-number">7.25</span>  <span class="hljs-number">5.15</span>    Yes   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.710345</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="63" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="63" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.3.2 分位数和桶分析</h3>
<p>我曾在第8章中讲过，pandas有一些能根据指定面元或样本分位数将数据拆分成多块的工具（比如cut和qcut）。将这些函数跟groupby结合起来，就能非常轻松地实现对数据集的桶（bucket）或分位数（quantile）分析了。以下面这个简单的随机数据集为例，我们利用cut将其装入长度相等的桶中：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="64" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="64" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">82</span>]: frame = pd.DataFrame({<span class="hljs-string">&#x27;data1&#x27;</span>: np.random.randn(<span class="hljs-number">1000</span>),
   ....:                       <span class="hljs-string">&#x27;data2&#x27;</span>: np.random.randn(<span class="hljs-number">1000</span>)})

In [<span class="hljs-number">83</span>]: quartiles = pd.cut(frame.data1, <span class="hljs-number">4</span>)

In [<span class="hljs-number">84</span>]: quartiles[:<span class="hljs-number">10</span>]
Out[<span class="hljs-number">84</span>]: 
<span class="hljs-number">0</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]
<span class="hljs-number">1</span>    (<span class="hljs-number">-2.956</span>, <span class="hljs-number">-1.23</span>]
<span class="hljs-number">2</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]
<span class="hljs-number">3</span>     (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]
<span class="hljs-number">4</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]
<span class="hljs-number">5</span>     (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]
<span class="hljs-number">6</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]
<span class="hljs-number">7</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]
<span class="hljs-number">8</span>     (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]
<span class="hljs-number">9</span>     (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]
Name: data1, dtype: category
Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">-2.956</span>, <span class="hljs-number">-1.23</span>] &lt; (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>] &lt; (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.</span>
<span class="hljs-number">208</span>] &lt; (<span class="hljs-number">2.208</span>, <span class="hljs-number">3.928</span>]]
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="65" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="65" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>由cut返回的Categorical对象可直接传递到groupby。因此，我们可以像下面这样对data2列做一些统计计算：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">85</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_stats</span>(<span class="hljs-params">group</span>):</span>
   ....:     <span class="hljs-keyword">return</span> {<span class="hljs-string">&#x27;min&#x27;</span>: group.min(), <span class="hljs-string">&#x27;max&#x27;</span>: group.max(),
   ....:             <span class="hljs-string">&#x27;count&#x27;</span>: group.count(), <span class="hljs-string">&#x27;mean&#x27;</span>: group.mean()}

In [<span class="hljs-number">86</span>]: grouped = frame.data2.groupby(quartiles)

In [<span class="hljs-number">87</span>]: grouped.apply(get_stats).unstack()
Out[<span class="hljs-number">87</span>]: 
                 count       max      mean       min
data1                                               
(<span class="hljs-number">-2.956</span>, <span class="hljs-number">-1.23</span>]   <span class="hljs-number">95.0</span>  <span class="hljs-number">1.670835</span> <span class="hljs-number">-0.039521</span> <span class="hljs-number">-3.399312</span>
(<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]   <span class="hljs-number">598.0</span>  <span class="hljs-number">3.260383</span> <span class="hljs-number">-0.002051</span> <span class="hljs-number">-2.989741</span>
(<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]   <span class="hljs-number">297.0</span>  <span class="hljs-number">2.954439</span>  <span class="hljs-number">0.081822</span> <span class="hljs-number">-3.745356</span>
(<span class="hljs-number">2.208</span>, <span class="hljs-number">3.928</span>]    <span class="hljs-number">10.0</span>  <span class="hljs-number">1.765640</span>  <span class="hljs-number">0.024750</span> <span class="hljs-number">-1.929776</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="66" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="66" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>这些都是长度相等的桶。要根据样本分位数得到大小相等的桶，使用qcut即可。传入labels=False即可只获取分位数的编号：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="67" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="67" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap><span class="hljs-comment"># Return quantile numbers</span>
In [<span class="hljs-number">88</span>]: grouping = pd.qcut(frame.data1, <span class="hljs-number">10</span>, labels=<span class="hljs-literal">False</span>)
In [<span class="hljs-number">89</span>]: grouped = frame.data2.groupby(grouping)
In [<span class="hljs-number">90</span>]: grouped.apply(get_stats).unstack()
Out[<span class="hljs-number">90</span>]: 
       count       max      mean       min
data1                                     
<span class="hljs-number">0</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">1.670835</span> <span class="hljs-number">-0.049902</span> <span class="hljs-number">-3.399312</span>
<span class="hljs-number">1</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.628441</span>  <span class="hljs-number">0.030989</span> <span class="hljs-number">-1.950098</span>
<span class="hljs-number">2</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.527939</span> <span class="hljs-number">-0.067179</span> <span class="hljs-number">-2.925113</span>
<span class="hljs-number">3</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">3.260383</span>  <span class="hljs-number">0.065713</span> <span class="hljs-number">-2.315555</span>
<span class="hljs-number">4</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.074345</span> <span class="hljs-number">-0.111653</span> <span class="hljs-number">-2.047939</span>
<span class="hljs-number">5</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.184810</span>  <span class="hljs-number">0.052130</span> <span class="hljs-number">-2.989741</span>
<span class="hljs-number">6</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.458842</span> <span class="hljs-number">-0.021489</span> <span class="hljs-number">-2.223506</span>
<span class="hljs-number">7</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.954439</span> <span class="hljs-number">-0.026459</span> <span class="hljs-number">-3.056990</span>
<span class="hljs-number">8</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.735527</span>  <span class="hljs-number">0.103406</span> <span class="hljs-number">-3.745356</span>
<span class="hljs-number">9</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.377020</span>  <span class="hljs-number">0.220122</span> <span class="hljs-number">-2.064111</span>
</span></span></foreignObject></svg></code></pre>
<p>我们会在第12章详细讲解pandas的Categorical类型。</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="68" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="68" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.3.3 示例：用特定于分组的值填充缺失值</h3>
<p>对于缺失数据的清理工作，有时你会用dropna将其替换掉，而有时则可能会希望用一个固定值或由数据集本身所衍生出来的值去填充NA值。这时就得使用fillna这个工具了。在下面这个例子中，我用平均值去填充NA值：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="69" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="69" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">91</span>]: s = pd.Series(np.random.randn(<span class="hljs-number">6</span>))

In [<span class="hljs-number">92</span>]: s[::<span class="hljs-number">2</span>] = np.nan

In [<span class="hljs-number">93</span>]: s
Out[<span class="hljs-number">93</span>]: 
<span class="hljs-number">0</span>         NaN
<span class="hljs-number">1</span>   <span class="hljs-number">-0.125921</span>
<span class="hljs-number">2</span>         NaN
<span class="hljs-number">3</span>   <span class="hljs-number">-0.884475</span>
<span class="hljs-number">4</span>         NaN
<span class="hljs-number">5</span>    <span class="hljs-number">0.227290</span>
dtype: float64

In [<span class="hljs-number">94</span>]: s.fillna(s.mean())
Out[<span class="hljs-number">94</span>]: 
<span class="hljs-number">0</span>   <span class="hljs-number">-0.261035</span>
<span class="hljs-number">1</span>   <span class="hljs-number">-0.125921</span>
<span class="hljs-number">2</span>   <span class="hljs-number">-0.261035</span>
<span class="hljs-number">3</span>   <span class="hljs-number">-0.884475</span>
<span class="hljs-number">4</span>   <span class="hljs-number">-0.261035</span>
<span class="hljs-number">5</span>    <span class="hljs-number">0.227290</span>
dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="70" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="70" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>假设你需要对不同的分组填充不同的值。一种方法是将数据分组，并使用apply和一个能够对各数据块调用fillna的函数即可。下面是一些有关美国几个州的示例数据，这些州又被分为东部和西部：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="71" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="71" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">95</span>]: states = [<span class="hljs-string">&#x27;Ohio&#x27;</span>, <span class="hljs-string">&#x27;New York&#x27;</span>, <span class="hljs-string">&#x27;Vermont&#x27;</span>, <span class="hljs-string">&#x27;Florida&#x27;</span>,
   ....:           <span class="hljs-string">&#x27;Oregon&#x27;</span>, <span class="hljs-string">&#x27;Nevada&#x27;</span>, <span class="hljs-string">&#x27;California&#x27;</span>, <span class="hljs-string">&#x27;Idaho&#x27;</span>]

In [<span class="hljs-number">96</span>]: group_key = [<span class="hljs-string">&#x27;East&#x27;</span>] * <span class="hljs-number">4</span> + [<span class="hljs-string">&#x27;West&#x27;</span>] * <span class="hljs-number">4</span>

In [<span class="hljs-number">97</span>]: data = pd.Series(np.random.randn(<span class="hljs-number">8</span>), index=states)

In [<span class="hljs-number">98</span>]: data
Out[<span class="hljs-number">98</span>]: 
Ohio          <span class="hljs-number">0.922264</span>
New York     <span class="hljs-number">-2.153545</span>
Vermont      <span class="hljs-number">-0.365757</span>
Florida      <span class="hljs-number">-0.375842</span>
Oregon        <span class="hljs-number">0.329939</span>
Nevada        <span class="hljs-number">0.981994</span>
California    <span class="hljs-number">1.105913</span>
Idaho        <span class="hljs-number">-1.613716</span>
dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="72" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="72" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>['East'] * 4产生了一个列表，包括了['East']中元素的四个拷贝。将这些列表串联起来。</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="73" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="73" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>将一些值设为缺失：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">99</span>]: data[[<span class="hljs-string">&#x27;Vermont&#x27;</span>, <span class="hljs-string">&#x27;Nevada&#x27;</span>, <span class="hljs-string">&#x27;Idaho&#x27;</span>]] = np.nan

In [<span class="hljs-number">100</span>]: data
Out[<span class="hljs-number">100</span>]: 
Ohio          <span class="hljs-number">0.922264</span>
New York     <span class="hljs-number">-2.153545</span>
Vermont            NaN
Florida      <span class="hljs-number">-0.375842</span>
Oregon        <span class="hljs-number">0.329939</span>
Nevada             NaN
California    <span class="hljs-number">1.105913</span>
Idaho              NaN
dtype: float64

In [<span class="hljs-number">101</span>]: data.groupby(group_key).mean()
Out[<span class="hljs-number">101</span>]: 
East   <span class="hljs-number">-0.535707</span>
West    <span class="hljs-number">0.717926</span>
dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="74" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="74" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>我们可以用分组平均值去填充NA值:</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">102</span>]: fill_mean = <span class="hljs-keyword">lambda</span> g: g.fillna(g.mean())

In [<span class="hljs-number">103</span>]: data.groupby(group_key).apply(fill_mean)
Out[<span class="hljs-number">103</span>]: 
Ohio          <span class="hljs-number">0.922264</span>
New York     <span class="hljs-number">-2.153545</span>
Vermont      <span class="hljs-number">-0.535707</span>
Florida      <span class="hljs-number">-0.375842</span>
Oregon        <span class="hljs-number">0.329939</span>
Nevada        <span class="hljs-number">0.717926</span>
California    <span class="hljs-number">1.105913</span>
Idaho         <span class="hljs-number">0.717926</span>
dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="75" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="75" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>另外，也可以在代码中预定义各组的填充值。由于分组具有一个name属性，所以我们可以拿来用一下：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">104</span>]: fill_values = {<span class="hljs-string">&#x27;East&#x27;</span>: <span class="hljs-number">0.5</span>, <span class="hljs-string">&#x27;West&#x27;</span>: <span class="hljs-number">-1</span>}

In [<span class="hljs-number">105</span>]: fill_func = <span class="hljs-keyword">lambda</span> g: g.fillna(fill_values[g.name])

In [<span class="hljs-number">106</span>]: data.groupby(group_key).apply(fill_func)
Out[<span class="hljs-number">106</span>]: 
Ohio          <span class="hljs-number">0.922264</span>
New York     <span class="hljs-number">-2.153545</span>
Vermont       <span class="hljs-number">0.500000</span>
Florida      <span class="hljs-number">-0.375842</span>
Oregon        <span class="hljs-number">0.329939</span>
Nevada       <span class="hljs-number">-1.000000</span>
California    <span class="hljs-number">1.105913</span>
Idaho        <span class="hljs-number">-1.000000</span>
dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="76" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="76" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.3.4 示例：随机采样和排列</h3>
<p>假设你想要从一个大数据集中随机抽取（进行替换或不替换）样本以进行蒙特卡罗模拟（Monte Carlo simulation）或其他分析工作。“抽取”的方式有很多，这里使用的方法是对Series使用sample方法：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap><span class="hljs-comment"># Hearts, Spades, Clubs, Diamonds</span>
suits = [<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]
card_val = (list(range(<span class="hljs-number">1</span>, <span class="hljs-number">11</span>)) + [<span class="hljs-number">10</span>] * <span class="hljs-number">3</span>) * <span class="hljs-number">4</span>
base_names = [<span class="hljs-string">&#x27;A&#x27;</span>] + list(range(<span class="hljs-number">2</span>, <span class="hljs-number">11</span>)) + [<span class="hljs-string">&#x27;J&#x27;</span>, <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;Q&#x27;</span>]
cards = []
<span class="hljs-keyword">for</span> suit <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;H&#x27;</span>, <span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>]:
    cards.extend(str(num) + suit <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> base_names)

deck = pd.Series(card_val, index=cards)
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="77" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="77" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>现在我有了一个长度为52的Series，其索引包括牌名，值则是21点或其他游戏中用于计分的点数（为了简单起见，我当A的点数为1）：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">108</span>]: deck[:<span class="hljs-number">13</span>]
Out[<span class="hljs-number">108</span>]: 
AH      <span class="hljs-number">1</span>
<span class="hljs-number">2</span>H      <span class="hljs-number">2</span>
<span class="hljs-number">3</span>H      <span class="hljs-number">3</span>
<span class="hljs-number">4</span>H      <span class="hljs-number">4</span>
<span class="hljs-number">5</span>H      <span class="hljs-number">5</span>
<span class="hljs-number">6</span>H      <span class="hljs-number">6</span>
<span class="hljs-number">7</span>H      <span class="hljs-number">7</span>
<span class="hljs-number">8</span>H      <span class="hljs-number">8</span>
<span class="hljs-number">9</span>H      <span class="hljs-number">9</span>
<span class="hljs-number">10</span>H    <span class="hljs-number">10</span>
JH     <span class="hljs-number">10</span>
KH     <span class="hljs-number">10</span>
QH     <span class="hljs-number">10</span>
dtype: int64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="78" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="78" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>现在，根据我上面所讲的，从整副牌中抽出5张，代码如下：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">109</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">draw</span>(<span class="hljs-params">deck, n=<span class="hljs-number">5</span></span>):</span>
   .....:     <span class="hljs-keyword">return</span> deck.sample(n)

In [<span class="hljs-number">110</span>]: draw(deck)
Out[<span class="hljs-number">110</span>]: 
AD     <span class="hljs-number">1</span>
<span class="hljs-number">8</span>C     <span class="hljs-number">8</span>
<span class="hljs-number">5</span>H     <span class="hljs-number">5</span>
KC    <span class="hljs-number">10</span>
<span class="hljs-number">2</span>C     <span class="hljs-number">2</span>
dtype: int64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="79" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="79" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>假设你想要从每种花色中随机抽取两张牌。由于花色是牌名的最后一个字符，所以我们可以据此进行分组，并使用apply：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">111</span>]: get_suit = <span class="hljs-keyword">lambda</span> card: card[<span class="hljs-number">-1</span>] <span class="hljs-comment"># last letter is suit</span>

In [<span class="hljs-number">112</span>]: deck.groupby(get_suit).apply(draw, n=<span class="hljs-number">2</span>)
Out[<span class="hljs-number">112</span>]: 
C  <span class="hljs-number">2</span>C     <span class="hljs-number">2</span>
   <span class="hljs-number">3</span>C     <span class="hljs-number">3</span>
D  KD    <span class="hljs-number">10</span>
   <span class="hljs-number">8</span>D     <span class="hljs-number">8</span>
H  KH    <span class="hljs-number">10</span>
   <span class="hljs-number">3</span>H     <span class="hljs-number">3</span>
S  <span class="hljs-number">2</span>S     <span class="hljs-number">2</span>
   <span class="hljs-number">4</span>S     <span class="hljs-number">4</span>
dtype: int64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="80" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="80" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>或者，也可以这样写：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">113</span>]: deck.groupby(get_suit, group_keys=<span class="hljs-literal">False</span>).apply(draw, n=<span class="hljs-number">2</span>)
Out[<span class="hljs-number">113</span>]: 
KC    <span class="hljs-number">10</span>
JC    <span class="hljs-number">10</span>
AD     <span class="hljs-number">1</span>
<span class="hljs-number">5</span>D     <span class="hljs-number">5</span>
<span class="hljs-number">5</span>H     <span class="hljs-number">5</span>
<span class="hljs-number">6</span>H     <span class="hljs-number">6</span>
<span class="hljs-number">7</span>S     <span class="hljs-number">7</span>
KS    <span class="hljs-number">10</span>
dtype: int64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="81" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="81" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<h3>10.3.5 示例：分组加权平均数和相关系数</h3>
<p>根据groupby的“拆分－应用－合并”范式，可以进行DataFrame的列与列之间或两个Series之间的运算（比如分组加权平均）。以下面这个数据集为例，它含有分组键、值以及一些权重值：</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="82" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="82" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">114</span>]: df = pd.DataFrame({<span class="hljs-string">&#x27;category&#x27;</span>: [<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>,
   .....:                                 <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>],
   .....:                    <span class="hljs-string">&#x27;data&#x27;</span>: np.random.randn(<span class="hljs-number">8</span>),
   .....:                    <span class="hljs-string">&#x27;weights&#x27;</span>: np.random.rand(<span class="hljs-number">8</span>)})

In [<span class="hljs-number">115</span>]: df
Out[<span class="hljs-number">115</span>]: 
  category      data   weights
<span class="hljs-number">0</span>        a  <span class="hljs-number">1.561587</span>  <span class="hljs-number">0.957515</span>
<span class="hljs-number">1</span>        a  <span class="hljs-number">1.219984</span>  <span class="hljs-number">0.347267</span>
<span class="hljs-number">2</span>        a <span class="hljs-number">-0.482239</span>  <span class="hljs-number">0.581362</span>
<span class="hljs-number">3</span>        a  <span class="hljs-number">0.315667</span>  <span class="hljs-number">0.217091</span>
<span class="hljs-number">4</span>        b <span class="hljs-number">-0.047852</span>  <span class="hljs-number">0.894406</span>
<span class="hljs-number">5</span>        b <span class="hljs-number">-0.454145</span>  <span class="hljs-number">0.918564</span>
<span class="hljs-number">6</span>        b <span class="hljs-number">-0.556774</span>  <span class="hljs-number">0.277825</span>
<span class="hljs-number">7</span>        b  <span class="hljs-number">0.253321</span>  <span class="hljs-number">0.955905</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="83" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="83" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>然后可以利用category计算分组加权平均数：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">116</span>]: grouped = df.groupby(<span class="hljs-string">&#x27;category&#x27;</span>)

In [<span class="hljs-number">117</span>]: get_wavg = <span class="hljs-keyword">lambda</span> g: np.average(g[<span class="hljs-string">&#x27;data&#x27;</span>], weights=g[<span class="hljs-string">&#x27;weights&#x27;</span>])

In [<span class="hljs-number">118</span>]: grouped.apply(get_wavg)
Out[<span class="hljs-number">118</span>]:
category
a    <span class="hljs-number">0.811643</span>
b   <span class="hljs-number">-0.122262</span>
dtype: float64
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="84" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="84" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>另一个例子，考虑一个来自Yahoo!Finance的数据集，其中含有几只股票和标准普尔500指数（符号SPX）的收盘价：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">119</span>]: close_px = pd.read_csv(<span class="hljs-string">&#x27;examples/stock_px_2.csv&#x27;</span>, parse_dates=<span class="hljs-literal">True</span>,
   .....:                        index_col=<span class="hljs-number">0</span>)
In [<span class="hljs-number">120</span>]: close_px.info() <span class="hljs-comment">#&lt;class &#x27;pandas.core.frame.DataFrame&#x27;&gt;</span>
DatetimeIndex: <span class="hljs-number">2214</span> entries, <span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> to <span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-14</span>
Data columns (total <span class="hljs-number">4</span> columns):
AAPL    <span class="hljs-number">2214</span> non-null float64
MSFT    <span class="hljs-number">2214</span> non-null float64
XOM     <span class="hljs-number">2214</span> non-null float64
SPX     <span class="hljs-number">2214</span> non-null float64
dtypes: float64(<span class="hljs-number">4</span>) memory usage: <span class="hljs-number">86.5</span> KB
In [<span class="hljs-number">121</span>]: close_px[<span class="hljs-number">-4</span>:]
Out[<span class="hljs-number">121</span>]: 
              AAPL   MSFT    XOM      SPX
<span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-11</span>  <span class="hljs-number">400.29</span>  <span class="hljs-number">27.00</span>  <span class="hljs-number">76.27</span>  <span class="hljs-number">1195.54</span>
<span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-12</span>  <span class="hljs-number">402.19</span>  <span class="hljs-number">26.96</span>  <span class="hljs-number">77.16</span>  <span class="hljs-number">1207.25</span>
<span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-13</span>  <span class="hljs-number">408.43</span>  <span class="hljs-number">27.18</span>  <span class="hljs-number">76.37</span>  <span class="hljs-number">1203.66</span>
<span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-14</span>  <span class="hljs-number">422.00</span>  <span class="hljs-number">27.27</span>  <span class="hljs-number">78.11</span>  <span class="hljs-number">1224.58</span>
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="85" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="85" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>来做一个比较有趣的任务：计算一个由日收益率（通过百分数变化计算）与SPX之间的年度相关系数组成的DataFrame。下面是一个实现办法，我们先创建一个函数，用它计算每列和SPX列的成对相关系数：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">122</span>]: spx_corr = <span class="hljs-keyword">lambda</span> x: x.corrwith(x[<span class="hljs-string">&#x27;SPX&#x27;</span>])
</span></span></foreignObject></svg></code></pre>
<p>接下来，我们使用pct_change计算close_px的百分比变化：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">123</span>]: rets = close_px.pct_change().dropna()
</span></span></foreignObject></svg></code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="86" data-paginate="true" data-background-color="#fff" data-background-image="url('https://marp.app/assets/hero-background.jpg')" data-theme="gaia" data-marpit-pagination="86" data-marpit-pagination-total="86" style="--paginate:true;--background-color:#fff;--background-image:url('https://marp.app/assets/hero-background.jpg');--theme:gaia;background-color:#fff;background-image:url('https://marp.app/assets/hero-background.jpg');background-position:center;background-repeat:no-repeat;background-size:cover;">
<p>最后，我们用年对百分比变化进行分组，可以用一个一行的函数，从每行的标签返回每个datetime标签的year属性：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">124</span>]: get_year = <span class="hljs-keyword">lambda</span> x: x.year

In [<span class="hljs-number">125</span>]: by_year = rets.groupby(get_year)

In [<span class="hljs-number">126</span>]: by_year.apply(spx_corr)
Out[<span class="hljs-number">126</span>]: 
          AAPL      MSFT       XOM  SPX
<span class="hljs-number">2003</span>  <span class="hljs-number">0.541124</span>  <span class="hljs-number">0.745174</span>  <span class="hljs-number">0.661265</span>  <span class="hljs-number">1.0</span>
<span class="hljs-number">2004</span>  <span class="hljs-number">0.374283</span>  <span class="hljs-number">0.588531</span>  <span class="hljs-number">0.557742</span>  <span class="hljs-number">1.0</span>
<span class="hljs-number">2005</span>  <span class="hljs-number">0.467540</span>  <span class="hljs-number">0.562374</span>  <span class="hljs-number">0.631010</span>  <span class="hljs-number">1.0</span>
<span class="hljs-number">2006</span>  <span class="hljs-number">0.428267</span>  <span class="hljs-number">0.406126</span>  <span class="hljs-number">0.518514</span>  <span class="hljs-number">1.0</span>
<span class="hljs-number">2007</span>  <span class="hljs-number">0.508118</span>  <span class="hljs-number">0.658770</span>  <span class="hljs-number">0.786264</span>  <span class="hljs-number">1.0</span>
<span class="hljs-number">2008</span>  <span class="hljs-number">0.681434</span>  <span class="hljs-number">0.804626</span>  <span class="hljs-number">0.828303</span>  <span class="hljs-number">1.0</span>
<span class="hljs-number">2009</span>  <span class="hljs-number">0.707103</span>  <span class="hljs-number">0.654902</span>  <span class="hljs-number">0.797921</span>  <span class="hljs-number">1.0</span>
<span class="hljs-number">2010</span>  <span class="hljs-number">0.710105</span>  <span class="hljs-number">0.730118</span>  <span class="hljs-number">0.839057</span>  <span class="hljs-number">1.0</span>
<span class="hljs-number">2011</span>  <span class="hljs-number">0.691931</span>  <span class="hljs-number">0.800996</span>  <span class="hljs-number">0.859975</span>  <span class="hljs-number">1.0</span>
</span></span></foreignObject></svg></code></pre>
<p>当然，你还可以计算列与列之间的相关系数。这里，我们计算Apple和Microsoft的年相关系数：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">127</span>]: by_year.apply(<span class="hljs-keyword">lambda</span> g: g[<span class="hljs-string">&#x27;AAPL&#x27;</span>].corr(g[<span class="hljs-string">&#x27;MSFT&#x27;</span>]))
Out[<span class="hljs-number">127</span>]: 
<span class="hljs-number">2003</span>    <span class="hljs-number">0.480868</span>
<span class="hljs-number">2004</span>    <span class="hljs-number">0.259024</span>
<span class="hljs-number">2005</span>    <span class="hljs-number">0.300093</span>
<span class="hljs-number">2006</span>    <span class="hljs-number">0.161735</span>
<span class="hljs-number">2007</span>    <span class="hljs-number">0.417738</span>
<span class="hljs-number">2008</span>    <span class="hljs-number">0.611901</span>
<span class="hljs-number">2009</span>    <span class="hljs-number">0.432738</span>
<span class="hljs-number">2010</span>    <span class="hljs-number">0.571946</span>
<span class="hljs-number">2011</span>    <span class="hljs-number">0.581987</span>
dtype: float64
</span></span></foreignObject></svg></code></pre>
<h2>示例：组级别的线性回归</h2>
<p>顺着上一个例子继续，你可以用groupby执行更为复杂的分组统计分析，只要函数返回的是pandas对象或标量值即可。例如，我可以定义下面这个regress函数（利用statsmodels计量经济学库）对各数据块执行普通最小二乘法（Ordinary Least Squares，OLS）回归：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap><span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">regress</span>(<span class="hljs-params">data, yvar, xvars</span>):</span>
    Y = data[yvar]
    X = data[xvars]
    X[<span class="hljs-string">&#x27;intercept&#x27;</span>] = <span class="hljs-number">1.</span>
    result = sm.OLS(Y, X).fit()
    <span class="hljs-keyword">return</span> result.params
</span></span></foreignObject></svg></code></pre>
<p>现在，为了按年计算AAPL对SPX收益率的线性回归，执行：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">129</span>]: by_year.apply(regress, <span class="hljs-string">&#x27;AAPL&#x27;</span>, [<span class="hljs-string">&#x27;SPX&#x27;</span>])
Out[<span class="hljs-number">129</span>]: 
           SPX  intercept
<span class="hljs-number">2003</span>  <span class="hljs-number">1.195406</span>   <span class="hljs-number">0.000710</span>
<span class="hljs-number">2004</span>  <span class="hljs-number">1.363463</span>   <span class="hljs-number">0.004201</span>
<span class="hljs-number">2005</span>  <span class="hljs-number">1.766415</span>   <span class="hljs-number">0.003246</span>
<span class="hljs-number">2006</span>  <span class="hljs-number">1.645496</span>   <span class="hljs-number">0.000080</span>
<span class="hljs-number">2007</span>  <span class="hljs-number">1.198761</span>   <span class="hljs-number">0.003438</span>
<span class="hljs-number">2008</span>  <span class="hljs-number">0.968016</span>  <span class="hljs-number">-0.001110</span>
<span class="hljs-number">2009</span>  <span class="hljs-number">0.879103</span>   <span class="hljs-number">0.002954</span>
<span class="hljs-number">2010</span>  <span class="hljs-number">1.052608</span>   <span class="hljs-number">0.001261</span>
<span class="hljs-number">2011</span>  <span class="hljs-number">0.806605</span>   <span class="hljs-number">0.001514</span>
</span></span></foreignObject></svg></code></pre>
<h1>10.4 透视表和交叉表</h1>
<p>透视表（pivot table）是各种电子表格程序和其他数据分析软件中一种常见的数据汇总工具。它根据一个或多个键对数据进行聚合，并根据行和列上的分组键将数据分配到各个矩形区域中。在Python和pandas中，可以通过本章所介绍的groupby功能以及（能够利用层次化索引的）重塑运算制作透视表。DataFrame有一个pivot_table方法，此外还有一个顶级的pandas.pivot_table函数。除能为groupby提供便利之外，pivot_table还可以添加分项小计，也叫做margins。</p>
<p>回到小费数据集，假设我想要根据day和smoker计算分组平均数（pivot_table的默认聚合类型），并将day和smoker放到行上：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">130</span>]: tips.pivot_table(index=[<span class="hljs-string">&#x27;day&#x27;</span>, <span class="hljs-string">&#x27;smoker&#x27;</span>])
Out[<span class="hljs-number">130</span>]: 
                 size       tip   tip_pct  total_bill
day  smoker                                          
Fri  No      <span class="hljs-number">2.250000</span>  <span class="hljs-number">2.812500</span>  <span class="hljs-number">0.151650</span>   <span class="hljs-number">18.420000</span>
     Yes     <span class="hljs-number">2.066667</span>  <span class="hljs-number">2.714000</span>  <span class="hljs-number">0.174783</span>   <span class="hljs-number">16.813333</span>
Sat  No      <span class="hljs-number">2.555556</span>  <span class="hljs-number">3.102889</span>  <span class="hljs-number">0.158048</span>   <span class="hljs-number">19.661778</span>
     Yes     <span class="hljs-number">2.476190</span>  <span class="hljs-number">2.875476</span>  <span class="hljs-number">0.147906</span>   <span class="hljs-number">21.276667</span>
Sun  No      <span class="hljs-number">2.929825</span>  <span class="hljs-number">3.167895</span>  <span class="hljs-number">0.160113</span>   <span class="hljs-number">20.506667</span>
     Yes     <span class="hljs-number">2.578947</span>  <span class="hljs-number">3.516842</span>  <span class="hljs-number">0.187250</span>   <span class="hljs-number">24.120000</span>
Thur No      <span class="hljs-number">2.488889</span>  <span class="hljs-number">2.673778</span>  <span class="hljs-number">0.160298</span>   <span class="hljs-number">17.113111</span>
     Yes     <span class="hljs-number">2.352941</span>  <span class="hljs-number">3.030000</span>  <span class="hljs-number">0.163863</span>   <span class="hljs-number">19.190588</span>
</span></span></foreignObject></svg></code></pre>
<p>可以用groupby直接来做。现在，假设我们只想聚合tip_pct和size，而且想根据time进行分组。我将smoker放到列上，把day放到行上：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">131</span>]: tips.pivot_table([<span class="hljs-string">&#x27;tip_pct&#x27;</span>, <span class="hljs-string">&#x27;size&#x27;</span>], index=[<span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;day&#x27;</span>],
   .....:                  columns=<span class="hljs-string">&#x27;smoker&#x27;</span>)
Out[<span class="hljs-number">131</span>]: 
                 size             tip_pct          
smoker             No       Yes        No       Yes
time   day                                         
Dinner Fri   <span class="hljs-number">2.000000</span>  <span class="hljs-number">2.222222</span>  <span class="hljs-number">0.139622</span>  <span class="hljs-number">0.165347</span>
       Sat   <span class="hljs-number">2.555556</span>  <span class="hljs-number">2.476190</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.147906</span>
       Sun   <span class="hljs-number">2.929825</span>  <span class="hljs-number">2.578947</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.187250</span>
       Thur  <span class="hljs-number">2.000000</span>       NaN  <span class="hljs-number">0.159744</span>       NaN
Lunch  Fri   <span class="hljs-number">3.000000</span>  <span class="hljs-number">1.833333</span>  <span class="hljs-number">0.187735</span>  <span class="hljs-number">0.188937</span>
       Thur  <span class="hljs-number">2.500000</span>  <span class="hljs-number">2.352941</span>  <span class="hljs-number">0.160311</span>  <span class="hljs-number">0.163863</span>
</span></span></foreignObject></svg></code></pre>
<p>还可以对这个表作进一步的处理，传入margins=True添加分项小计。这将会添加标签为All的行和列，其值对应于单个等级中所有数据的分组统计：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">132</span>]: tips.pivot_table([<span class="hljs-string">&#x27;tip_pct&#x27;</span>, <span class="hljs-string">&#x27;size&#x27;</span>], index=[<span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;day&#x27;</span>],
   .....:                  columns=<span class="hljs-string">&#x27;smoker&#x27;</span>, margins=<span class="hljs-literal">True</span>)
Out[<span class="hljs-number">132</span>]: 
                 size                       tip_pct                    
smoker             No       Yes       All        No       Yes       All
time   day                                                             
Dinner Fri   <span class="hljs-number">2.000000</span>  <span class="hljs-number">2.222222</span>  <span class="hljs-number">2.166667</span>  <span class="hljs-number">0.139622</span>  <span class="hljs-number">0.165347</span>  <span class="hljs-number">0.158916</span>
       Sat   <span class="hljs-number">2.555556</span>  <span class="hljs-number">2.476190</span>  <span class="hljs-number">2.517241</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.153152</span>
       Sun   <span class="hljs-number">2.929825</span>  <span class="hljs-number">2.578947</span>  <span class="hljs-number">2.842105</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.166897</span>
       Thur  <span class="hljs-number">2.000000</span>       NaN  <span class="hljs-number">2.000000</span>  <span class="hljs-number">0.159744</span>       NaN  <span class="hljs-number">0.159744</span>
Lunch  Fri   <span class="hljs-number">3.000000</span>  <span class="hljs-number">1.833333</span>  <span class="hljs-number">2.000000</span>  <span class="hljs-number">0.187735</span>  <span class="hljs-number">0.188937</span>  <span class="hljs-number">0.188765</span>
       Thur  <span class="hljs-number">2.500000</span>  <span class="hljs-number">2.352941</span>  <span class="hljs-number">2.459016</span>  <span class="hljs-number">0.160311</span>  <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.161301</span>
All          <span class="hljs-number">2.668874</span>  <span class="hljs-number">2.408602</span>  <span class="hljs-number">2.569672</span>  <span class="hljs-number">0.159328</span>  <span class="hljs-number">0.163196</span>  <span class="hljs-number">0.160803</span>
</span></span></foreignObject></svg></code></pre>
<p>这里，All值为平均数：不单独考虑烟民与非烟民（All列），不单独考虑行分组两个级别中的任何单项（All行）。</p>
<p>要使用其他的聚合函数，将其传给aggfunc即可。例如，使用count或len可以得到有关分组大小的交叉表（计数或频率）：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">133</span>]: tips.pivot_table(<span class="hljs-string">&#x27;tip_pct&#x27;</span>, index=[<span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;smoker&#x27;</span>], columns=<span class="hljs-string">&#x27;day&#x27;</span>,
   .....:                  aggfunc=len, margins=<span class="hljs-literal">True</span>)
Out[<span class="hljs-number">133</span>]: 
day             Fri   Sat   Sun  Thur    All
time   smoker                               
Dinner No       <span class="hljs-number">3.0</span>  <span class="hljs-number">45.0</span>  <span class="hljs-number">57.0</span>   <span class="hljs-number">1.0</span>  <span class="hljs-number">106.0</span>
       Yes      <span class="hljs-number">9.0</span>  <span class="hljs-number">42.0</span>  <span class="hljs-number">19.0</span>   NaN   <span class="hljs-number">70.0</span>
Lunch  No       <span class="hljs-number">1.0</span>   NaN   NaN  <span class="hljs-number">44.0</span>   <span class="hljs-number">45.0</span>
       Yes      <span class="hljs-number">6.0</span>   NaN   NaN  <span class="hljs-number">17.0</span>   <span class="hljs-number">23.0</span>
All            <span class="hljs-number">19.0</span>  <span class="hljs-number">87.0</span>  <span class="hljs-number">76.0</span>  <span class="hljs-number">62.0</span>  <span class="hljs-number">244.0</span>
</span></span></foreignObject></svg></code></pre>
<p>如果存在空的组合（也就是NA），你可能会希望设置一个fill_value：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">134</span>]: tips.pivot_table(<span class="hljs-string">&#x27;tip_pct&#x27;</span>, index=[<span class="hljs-string">&#x27;time&#x27;</span>, <span class="hljs-string">&#x27;size&#x27;</span>, <span class="hljs-string">&#x27;smoker&#x27;</span>],
   .....:                  columns=<span class="hljs-string">&#x27;day&#x27;</span>, aggfunc=<span class="hljs-string">&#x27;mean&#x27;</span>, fill_value=<span class="hljs-number">0</span>)
Out[<span class="hljs-number">134</span>]: 
day                      Fri       Sat       Sun      Thur
time   size smoker                                        
Dinner <span class="hljs-number">1</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.137931</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>
            Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.325733</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>
       <span class="hljs-number">2</span>    No      <span class="hljs-number">0.139622</span>  <span class="hljs-number">0.162705</span>  <span class="hljs-number">0.168859</span>  <span class="hljs-number">0.159744</span>
            Yes     <span class="hljs-number">0.171297</span>  <span class="hljs-number">0.148668</span>  <span class="hljs-number">0.207893</span>  <span class="hljs-number">0.000000</span>
       <span class="hljs-number">3</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.154661</span>  <span class="hljs-number">0.152663</span>  <span class="hljs-number">0.000000</span>
            Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.144995</span>  <span class="hljs-number">0.152660</span>  <span class="hljs-number">0.000000</span>
       <span class="hljs-number">4</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.150096</span>  <span class="hljs-number">0.148143</span>  <span class="hljs-number">0.000000</span>
            Yes     <span class="hljs-number">0.117750</span>  <span class="hljs-number">0.124515</span>  <span class="hljs-number">0.193370</span>  <span class="hljs-number">0.000000</span>
       <span class="hljs-number">5</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.206928</span>  <span class="hljs-number">0.000000</span>
Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.106572</span>  <span class="hljs-number">0.065660</span>  <span class="hljs-number">0.000000</span>
<span class="hljs-meta">... </span>                     ...       ...       ...       ...
Lunch  <span class="hljs-number">1</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.181728</span>
            Yes     <span class="hljs-number">0.223776</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>
       <span class="hljs-number">2</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.166005</span>
            Yes     <span class="hljs-number">0.181969</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.158843</span>
       <span class="hljs-number">3</span>    No      <span class="hljs-number">0.187735</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.084246</span>
            Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.204952</span>
       <span class="hljs-number">4</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.138919</span>
            Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.155410</span>
       <span class="hljs-number">5</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.121389</span>
       <span class="hljs-number">6</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.173706</span>
[<span class="hljs-number">21</span> rows x <span class="hljs-number">4</span> columns]
</span></span></foreignObject></svg></code></pre>
<p>pivot_table的参数说明请参见表10-2。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/7178691-c9e01844c4803a42.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="表10-2 pivot_table的选项" /></p>
<h2>交叉表：crosstab</h2>
<p>交叉表（cross-tabulation，简称crosstab）是一种用于计算分组频率的特殊透视表。看下面的例子：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">138</span>]: data
Out[<span class="hljs-number">138</span>]:
   Sample Nationality    Handedness
<span class="hljs-number">0</span>       <span class="hljs-number">1</span>         USA  Right-handed
<span class="hljs-number">1</span>       <span class="hljs-number">2</span>       Japan   Left-handed
<span class="hljs-number">2</span>       <span class="hljs-number">3</span>         USA  Right-handed
<span class="hljs-number">3</span>       <span class="hljs-number">4</span>       Japan  Right-handed
<span class="hljs-number">4</span>       <span class="hljs-number">5</span>       Japan   Left-handed
<span class="hljs-number">5</span>       <span class="hljs-number">6</span>       Japan  Right-handed
<span class="hljs-number">6</span>       <span class="hljs-number">7</span>         USA  Right-handed
<span class="hljs-number">7</span>       <span class="hljs-number">8</span>         USA   Left-handed
<span class="hljs-number">8</span>       <span class="hljs-number">9</span>       Japan  Right-handed
<span class="hljs-number">9</span>      <span class="hljs-number">10</span>         USA  Right-handed
</span></span></foreignObject></svg></code></pre>
<p>作为调查分析的一部分，我们可能想要根据国籍和用手习惯对这段数据进行统计汇总。虽然可以用pivot_table实现该功能，但是pandas.crosstab函数会更方便：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">139</span>]: pd.crosstab(data.Nationality, data.Handedness, margins=<span class="hljs-literal">True</span>)
Out[<span class="hljs-number">139</span>]: 
Handedness   Left-handed  Right-handed  All
Nationality
Japan                  <span class="hljs-number">2</span>             <span class="hljs-number">3</span>    <span class="hljs-number">5</span>
USA                    <span class="hljs-number">1</span>             <span class="hljs-number">4</span>    <span class="hljs-number">5</span>
All                    <span class="hljs-number">3</span>             <span class="hljs-number">7</span>   <span class="hljs-number">10</span>
</span></span></foreignObject></svg></code></pre>
<p>crosstab的前两个参数可以是数组或Series，或是数组列表。就像小费数据：</p>
<pre><code class="language-python"><svg data-marp-fitting="svg" data-marp-fitting-code><foreignObject><span data-marp-fitting-svg-content><span data-marp-fitting-svg-content-wrap>In [<span class="hljs-number">140</span>]: pd.crosstab([tips.time, tips.day], tips.smoker, margins=<span class="hljs-literal">True</span>)
Out[<span class="hljs-number">140</span>]: 
smoker        No  Yes  All
time   day                
Dinner Fri     <span class="hljs-number">3</span>    <span class="hljs-number">9</span>   <span class="hljs-number">12</span>
       Sat    <span class="hljs-number">45</span>   <span class="hljs-number">42</span>   <span class="hljs-number">87</span>
       Sun    <span class="hljs-number">57</span>   <span class="hljs-number">19</span>   <span class="hljs-number">76</span>
       Thur    <span class="hljs-number">1</span>    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>
Lunch  Fri     <span class="hljs-number">1</span>    <span class="hljs-number">6</span>    <span class="hljs-number">7</span>
       Thur   <span class="hljs-number">44</span>   <span class="hljs-number">17</span>   <span class="hljs-number">61</span>
All          <span class="hljs-number">151</span>   <span class="hljs-number">93</span>  <span class="hljs-number">244</span>
</span></span></foreignObject></svg></code></pre>
<h1>10.5 总结</h1>
<p>掌握pandas数据分组工具既有助于数据清理，也有助于建模或统计分析工作。在第14章，我们会看几个例子，对真实数据使用groupby。</p>
<p>在下一章，我们将关注时间序列数据。</p>
</section>
<script>!function(){"use strict";const t="marpitSVGPolyfill:setZoomFactor,",e=Symbol();let o,r;function n(n){const i="object"==typeof n&&n.target||document,a="object"==typeof n?n.zoom:n;window[e]||(Object.defineProperty(window,e,{configurable:!0,value:!0}),window.addEventListener("message",({data:e,origin:o})=>{if(o===window.origin)try{if(e&&"string"==typeof e&&e.startsWith(t)){const[,t]=e.split(","),o=Number.parseFloat(t);Number.isNaN(o)||(r=o)}}catch(t){console.error(t)}}));let l=!1;Array.from(i.querySelectorAll("svg[data-marpit-svg]"),t=>{var e,n,i,s;t.style.transform||(t.style.transform="translateZ(0)");const c=a||r||t.currentScale||1;o!==c&&(o=c,l=c);const d=t.getBoundingClientRect(),{length:u}=t.children;for(let o=0;o<u;o+=1){const r=t.children[o],a=r.getScreenCTM();if(a){const t=null!==(n=null===(e=r.x)||void 0===e?void 0:e.baseVal.value)&&void 0!==n?n:0,o=null!==(s=null===(i=r.y)||void 0===i?void 0:i.baseVal.value)&&void 0!==s?s:0,l=r.firstChild,{style:u}=l;u.transformOrigin||(u.transformOrigin=`${-t}px ${-o}px`),u.transform=`scale(${c}) matrix(${a.a}, ${a.b}, ${a.c}, ${a.d}, ${a.e-d.left}, ${a.f-d.top}) translateZ(0.0001px)`}}}),!1!==l&&Array.from(i.querySelectorAll("iframe"),({contentWindow:e})=>{null==e||e.postMessage(`${t}${l}`,"null"===window.origin?"*":window.origin)})}o=1,r=void 0;const i=(t,e,o)=>{if(t.getAttribute(e)!==o)return t.setAttribute(e,o),!0};function a(t={}){const e="boolean"==typeof t?(t=>{const e=!t;return console.warn(`[DEPRECATION WARNING] Usage of observer() with boolean option has been deprecated. Please replace with the usage of option object: observer({ once: ${e?"true":"false"} }).`),{once:e}})(t):t,{once:o=!1,target:r=document}=e,a="Apple Computer, Inc."===navigator.vendor?[n]:[];let l=!o;const s=()=>{for(const t of a)t({target:r});!function(t=document){Array.from(t.querySelectorAll('svg[data-marp-fitting="svg"]'),t=>{var e;const o=t.firstChild,r=o.firstChild,{scrollWidth:n,scrollHeight:a}=r;let l,s=1;if(t.hasAttribute("data-marp-fitting-code")&&(l=null===(e=t.parentElement)||void 0===e?void 0:e.parentElement),t.hasAttribute("data-marp-fitting-math")&&(l=t.parentElement),l){const t=getComputedStyle(l),e=Math.ceil(l.clientWidth-parseFloat(t.paddingLeft||"0")-parseFloat(t.paddingRight||"0"));e&&(s=e)}const c=Math.max(n,s),d=Math.max(a,1),u=`0 0 ${c} ${d}`;i(o,"width",""+c),i(o,"height",""+d),i(t,"preserveAspectRatio",getComputedStyle(t).getPropertyValue("--preserve-aspect-ratio")||"xMinYMin meet"),i(t,"viewBox",u)&&t.classList.toggle("__reflow__")})}(r),l&&window.requestAnimationFrame(s)};return s(),()=>{l=!1}}const l=Symbol(),s=document.currentScript;((t=document)=>{if("undefined"==typeof window)throw new Error("Marp Core's browser script is valid only in browser context.");if(t[l])return t[l];const e=a({target:t}),o=()=>{e(),delete t[l]};Object.defineProperty(t,l,{configurable:!0,value:o})})(s?s.getRootNode():document)}();
</script></foreignObject></svg></div><script>!function(){"use strict";var e=function(e,t){var n,r=1===(e.parent||e).nodeType?e.parent||e:document.querySelector(e.parent||e),a=[].filter.call("string"==typeof e.slides?r.querySelectorAll(e.slides):e.slides||r.children,(function(e){return"SCRIPT"!==e.nodeName})),s={},i=function(e,t){return(t=t||{}).index=a.indexOf(e),t.slide=e,t},o=function(e,t){s[e]=(s[e]||[]).filter((function(e){return e!==t}))},l=function(e,t){return(s[e]||[]).reduce((function(e,n){return e&&!1!==n(t)}),!0)},c=function(e,t){a[e]&&(n&&l("deactivate",i(n,t)),n=a[e],l("activate",i(n,t)))},d=function(e,t){var r=a.indexOf(n)+e;l(e>0?"next":"prev",i(n,t))&&c(r,t)},u={off:o,on:function(e,t){return(s[e]||(s[e]=[])).push(t),o.bind(null,e,t)},fire:l,slide:function(e,t){if(!arguments.length)return a.indexOf(n);l("slide",i(a[e],t))&&c(e,t)},next:d.bind(null,1),prev:d.bind(null,-1),parent:r,slides:a,destroy:function(e){l("destroy",i(n,e)),s={}}};return(t||[]).forEach((function(e){e(u)})),n||c(0),u};function t(e){e.parent.classList.add("bespoke-marp-parent"),e.slides.forEach(e=>e.classList.add("bespoke-marp-slide")),e.on("activate",t=>{const n=t.slide,r=!n.classList.contains("bespoke-marp-active");e.slides.forEach(e=>{e.classList.remove("bespoke-marp-active"),e.setAttribute("aria-hidden","true")}),n.classList.add("bespoke-marp-active"),n.removeAttribute("aria-hidden"),r&&(n.classList.add("bespoke-marp-active-ready"),document.body.clientHeight,n.classList.remove("bespoke-marp-active-ready"))})}function n(e){let t=0,n=0;Object.defineProperty(e,"fragments",{enumerable:!0,value:e.slides.map(e=>[null,...e.querySelectorAll("[data-marpit-fragment]")])});const r=r=>void 0!==e.fragments[t][n+r],a=(r,a)=>{t=r,n=a,e.fragments.forEach((e,t)=>{e.forEach((e,n)=>{if(null==e)return;const s=t<r||t===r&&n<=a;e.setAttribute("data-bespoke-marp-fragment",s?"active":"inactive"),t===r&&n===a?e.setAttribute("data-bespoke-marp-current-fragment","current"):e.removeAttribute("data-bespoke-marp-current-fragment")})}),e.fragmentIndex=a;const s={slide:e.slides[r],index:r,fragments:e.fragments[r],fragmentIndex:a};e.fire("fragment",s)};e.on("next",({fragment:s=!0})=>{if(s){if(r(1))return a(t,n+1),!1;const s=t+1;e.fragments[s]&&a(s,0)}else{const r=e.fragments[t].length;if(n+1<r)return a(t,r-1),!1;const s=e.fragments[t+1];s&&a(t+1,s.length-1)}}),e.on("prev",({fragment:s=!0})=>{if(r(-1)&&s)return a(t,n-1),!1;const i=t-1;e.fragments[i]&&a(i,e.fragments[i].length-1)}),e.on("slide",({index:t,fragment:n})=>{let r=0;if(void 0!==n){const a=e.fragments[t];if(a){const{length:e}=a;r=-1===n?e-1:Math.min(Math.max(n,0),e-1)}}a(t,r)}),a(0,0)}var r,a,s=(function(e){
/*!
* screenfull
* v5.0.2 - 2020-02-13
* (c) Sindre Sorhus; MIT License
*/
!function(){var t="undefined"!=typeof window&&void 0!==window.document?window.document:{},n=e.exports,r=function(){for(var e,n=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],r=0,a=n.length,s={};r<a;r++)if((e=n[r])&&e[1]in t){for(r=0;r<e.length;r++)s[n[0][r]]=e[r];return s}return!1}(),a={change:r.fullscreenchange,error:r.fullscreenerror},s={request:function(e){return new Promise(function(n,a){var s=function(){this.off("change",s),n()}.bind(this);this.on("change",s);var i=(e=e||t.documentElement)[r.requestFullscreen]();i instanceof Promise&&i.then(s).catch(a)}.bind(this))},exit:function(){return new Promise(function(e,n){if(this.isFullscreen){var a=function(){this.off("change",a),e()}.bind(this);this.on("change",a);var s=t[r.exitFullscreen]();s instanceof Promise&&s.then(a).catch(n)}else e()}.bind(this))},toggle:function(e){return this.isFullscreen?this.exit():this.request(e)},onchange:function(e){this.on("change",e)},onerror:function(e){this.on("error",e)},on:function(e,n){var r=a[e];r&&t.addEventListener(r,n,!1)},off:function(e,n){var r=a[e];r&&t.removeEventListener(r,n,!1)},raw:r};r?(Object.defineProperties(s,{isFullscreen:{get:function(){return Boolean(t[r.fullscreenElement])}},element:{enumerable:!0,get:function(){return t[r.fullscreenElement]}},isEnabled:{enumerable:!0,get:function(){return Boolean(t[r.fullscreenEnabled])}}}),n?e.exports=s:window.screenfull=s):n?e.exports={isEnabled:!1}:window.screenfull={isEnabled:!1}}()}(a={path:r,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&a.path)}},a.exports),a.exports);function i(e){e.fullscreen=()=>{s.isEnabled&&s.toggle(document.body)},document.addEventListener("keydown",t=>{70!==t.which&&122!==t.which||t.altKey||t.ctrlKey||t.metaKey||!s.isEnabled||(e.fullscreen(),t.preventDefault())})}function o(e=2e3){return t=>{let n;function r(){n&&clearTimeout(n),n=setTimeout(()=>{t.parent.classList.add("bespoke-marp-inactive"),t.fire("marp-inactive")},e),t.parent.classList.contains("bespoke-marp-inactive")&&(t.parent.classList.remove("bespoke-marp-inactive"),t.fire("marp-active"))}document.addEventListener("mousedown",r),document.addEventListener("mousemove",r),document.addEventListener("touchend",r),setTimeout(r,0)}}const l=["AUDIO","BUTTON","INPUT","SELECT","TEXTAREA","VIDEO"];function c(e){e.parent.addEventListener("keydown",e=>{if(!e.target)return;const t=e.target;(l.includes(t.nodeName)||"true"===t.contentEditable)&&e.stopPropagation()})}function d(e){window.addEventListener("load",()=>{for(const t of e.slides){const e=t.querySelector("[data-marp-fitting]")?"":"hideable";t.setAttribute("data-bespoke-marp-load",e)}})}var u;function f({interval:e=200}={}){return t=>{document.addEventListener("keydown",e=>{if(32===e.which&&e.shiftKey)t.prev();else if(33===e.which||37===e.which||38===e.which)t.prev({fragment:!e.shiftKey});else if(32!==e.which||e.shiftKey)if(34===e.which||39===e.which||40===e.which)t.next({fragment:!e.shiftKey});else if(35===e.which)t.slide(t.slides.length-1,{fragment:-1});else{if(36!==e.which)return;t.slide(0)}else t.next();e.preventDefault()});let n,r,a=0;t.parent.addEventListener("wheel",s=>{let i=!1;const o=(e,t)=>{e&&(i=i||function(e,t){return function(e,t){const n=t===u.X?"Width":"Height";return e["client"+n]<e["scroll"+n]}(e,t)&&function(e,t){const{overflow:n}=e,r=e["overflow"+t];return"auto"===n||"scroll"===n||"auto"===r||"scroll"===r}(getComputedStyle(e),t)}(e,t)),(null==e?void 0:e.parentElement)&&o(e.parentElement,t)};if(0!==s.deltaX&&o(s.target,u.X),0!==s.deltaY&&o(s.target,u.Y),i)return;s.preventDefault(),r&&clearTimeout(r),r=setTimeout(()=>{n=0},e);const l=Date.now()-a<e,c=Math.sqrt(Math.pow(s.deltaX,2)+Math.pow(s.deltaY,2)),d=c<=n;if(n=c,l||d)return;let f;(s.deltaX>0||s.deltaY>0)&&(f="next"),(s.deltaX<0||s.deltaY<0)&&(f="prev"),f&&(t[f](),a=Date.now())})}}!function(e){e.X="X",e.Y="Y"}(u||(u={}));const m=(...e)=>history.replaceState(...e),p="data-bespoke-view";var h;!function(e){e.Normal="",e.Presenter="presenter",e.Next="next"}(h||(h={}));const g=(e,{protocol:t,host:n,pathname:r,hash:a}=location)=>{const s=e.toString();return`${t}//${n}${r}${s?"?":""}${s}${a}`},v=()=>{switch(document.body.getAttribute(p)){case h.Normal:return h.Normal;case h.Presenter:return h.Presenter;case h.Next:return h.Next;default:throw new Error("View mode is not assigned.")}},b=e=>new URLSearchParams(location.search).get(e),w=(e,t={})=>{const n=Object.assign({location:location,setter:m},t),r=new URLSearchParams(n.location.search);for(const t of Object.keys(e)){const n=e[t];"string"==typeof n?r.set(t,n):r.delete(t)}try{n.setter(null,document.title,g(r,n.location))}catch(e){console.error(e)}},y={available:(()=>{try{return localStorage.setItem("bespoke-marp","bespoke-marp"),localStorage.removeItem("bespoke-marp"),!0}catch(e){return console.warn("Warning: Using localStorage is restricted in the current host so some features may not work."),!1}})(),get:e=>{try{return localStorage.getItem(e)}catch(e){return null}},set:(e,t)=>{try{return localStorage.setItem(e,t),!0}catch(e){return!1}},remove:e=>{try{return localStorage.removeItem(e),!0}catch(e){return!1}}};function x(e=".bespoke-marp-osc"){const t=document.querySelector(e);if(!t)return()=>{};const n=(e,n)=>{t.querySelectorAll(`[data-bespoke-marp-osc=${JSON.stringify(e)}]`).forEach(n)};return s.isEnabled||n("fullscreen",e=>e.style.display="none"),y.available||n("presenter",e=>{e.disabled=!0,e.title="Presenter view is disabled due to restricted localStorage."}),e=>{t.addEventListener("click",t=>{if(t.target instanceof HTMLElement){const{bespokeMarpOsc:n}=t.target.dataset;switch(n&&t.target.blur(),n){case"next":e.next({fragment:!t.shiftKey});break;case"prev":e.prev({fragment:!t.shiftKey});break;case"fullscreen":"function"==typeof e.fullscreen&&s.isEnabled&&e.fullscreen();break;case"presenter":e.openPresenterView()}}}),e.parent.appendChild(t),e.on("activate",({index:t})=>{n("page",n=>n.textContent=`Page ${t+1} of ${e.slides.length}`)}),e.on("fragment",({index:t,fragments:r,fragmentIndex:a})=>{n("prev",e=>e.disabled=0===t&&0===a),n("next",n=>n.disabled=t===e.slides.length-1&&a===r.length-1)}),e.on("marp-active",()=>t.removeAttribute("aria-hidden")),e.on("marp-inactive",()=>t.setAttribute("aria-hidden","true")),s.isEnabled&&s.onchange(()=>n("fullscreen",e=>e.classList.toggle("exit",s.isEnabled&&s.isFullscreen)))}}function E(){const e=Math.max(Math.floor(.85*window.innerWidth),640),t=Math.max(Math.floor(.85*window.innerHeight),360);return window.open(this.presenterUrl,"bespoke-marp-presenter-"+this.syncKey,`width=${e},height=${t},menubar=no,toolbar=no`)}function k(){const e=new URLSearchParams(location.search);return e.set("view","presenter"),e.set("sync",this.syncKey),g(e)}var L=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];let S=e=>String(e).replace(/[&<>"']/g,e=>`&${I[e]};`),I={"&":"amp","<":"lt",">":"gt",'"':"quot","'":"apos"},P="dangerouslySetInnerHTML",M={className:"class",htmlFor:"for"},N={};function F(e,t){let n=[],r="";t=t||{};for(let e=arguments.length;e-- >2;)n.push(arguments[e]);if("function"==typeof e)return t.children=n.reverse(),e(t);if(e){if(r+="<"+e,t)for(let e in t)!1!==t[e]&&null!=t[e]&&e!==P&&(r+=` ${M[e]?M[e]:S(e)}="${S(t[e])}"`);r+=">"}if(-1===L.indexOf(e)){if(t[P])r+=t[P].__html;else for(;n.length;){let e=n.pop();if(e)if(e.pop)for(let t=e.length;t--;)n.push(e[t]);else r+=!0===N[e]?e:S(e)}r+=e?`</${e}>`:""}return N[r]=!0,r}const O=({children:e})=>F(null,null,...e),q="bespoke-marp-presenter-container",C="bespoke-marp-presenter-next",T="bespoke-marp-presenter-next-container",A="bespoke-marp-presenter-note-container",K="bespoke-marp-presenter-info-container",$="bespoke-marp-presenter-info-page",j="bespoke-marp-presenter-info-page-text",D="bespoke-marp-presenter-info-page-prev",R="bespoke-marp-presenter-info-page-next",U="bespoke-marp-presenter-info-time",V="bespoke-marp-presenter-info-timer";function X(e){const{title:t}=document;document.title="[Presenter view]"+(t?" - "+t:"");const n={},r=e=>(n[e]=n[e]||document.querySelector("."+e),n[e]);document.body.appendChild((e=>{const t=document.createElement("div");return t.className=q,t.appendChild(e),t.insertAdjacentHTML("beforeend",F(O,null,F("div",{class:T},F("iframe",{class:C,src:"?view=next"})),F("div",{class:A}),F("div",{class:K},F("div",{class:$},F("button",{class:D,tabindex:"-1",title:"Previous"},"Previous"),F("span",{class:j}),F("button",{class:R,tabindex:"-1",title:"Next"},"Next")),F("time",{class:U,title:"Current time"}),F("div",{class:V})))),t})(e.parent)),(e=>{r(T).addEventListener("click",()=>e.next());const t=r(C),n=(a=t,(e,t)=>{var n;return null===(n=a.contentWindow)||void 0===n?void 0:n.postMessage(`navigate:${e},${t}`,"null"===window.origin?"*":window.origin)});var a;t.addEventListener("load",()=>{r(T).classList.add("active"),n(e.slide(),e.fragmentIndex),e.on("fragment",({index:e,fragmentIndex:t})=>n(e,t))});const s=document.querySelectorAll(".bespoke-marp-note");s.forEach(e=>{e.addEventListener("keydown",e=>e.stopPropagation()),r(A).appendChild(e)}),e.on("activate",()=>s.forEach(t=>t.classList.toggle("active",t.dataset.index==e.slide()))),e.on("activate",({index:t})=>{r(j).textContent=`${t+1} / ${e.slides.length}`});const i=r(D),o=r(R);i.addEventListener("click",t=>{i.blur(),e.prev({fragment:!t.shiftKey})}),o.addEventListener("click",t=>{o.blur(),e.next({fragment:!t.shiftKey})}),e.on("fragment",({index:t,fragments:n,fragmentIndex:r})=>{i.disabled=0===t&&0===r,o.disabled=t===e.slides.length-1&&r===n.length-1});const l=()=>r(U).textContent=(new Date).toLocaleTimeString();l(),setInterval(l,250)})(e)}function Y(e){const t=v();return t===h.Next&&e.appendChild(document.createElement("span")),e=>{t===h.Normal&&function(e){if(!(e=>e.syncKey&&"string"==typeof e.syncKey)(e))throw new Error("The current instance of Bespoke.js is invalid for Marp bespoke presenter plugin.");Object.defineProperties(e,{openPresenterView:{enumerable:!0,value:E},presenterUrl:{enumerable:!0,get:k}}),y.available&&document.addEventListener("keydown",t=>{80!==t.which||t.altKey||t.ctrlKey||t.metaKey||(t.preventDefault(),e.openPresenterView())})}(e),t===h.Presenter&&X(e),t===h.Next&&function(e){const t=t=>{if(t.origin!==window.origin)return;const[n,r]=t.data.split(":");if("navigate"===n){const[t,n]=r.split(",");let a=Number.parseInt(t,10),s=Number.parseInt(n,10)+1;s>=e.fragments[a].length&&(a+=1,s=0),e.slide(a,{fragment:s})}};window.addEventListener("message",t),e.on("destroy",()=>window.removeEventListener("message",t))}(e)}}function B(e){e.on("activate",t=>{document.querySelectorAll(".bespoke-progress-bar").forEach(n=>{n.style.flexBasis=100*t.index/(e.slides.length-1)+"%"})})}const z=e=>{const t=Number.parseInt(e,10);return Number.isNaN(t)?null:t};function H(e={}){const t=Object.assign({history:!0},e);return e=>{let n=!0;const r=e=>{const t=n;try{return n=!0,e()}finally{n=t}},a=(t={fragment:!0})=>{((t,n)=>{const{fragments:r,slides:a}=e,s=Math.max(0,Math.min(t,a.length-1)),i=Math.max(0,Math.min(n||0,r[s].length-1));s===e.slide()&&i===e.fragmentIndex||e.slide(s,{fragment:i})})((z(location.hash.slice(1))||1)-1,t.fragment?z(b("f")||""):null)};e.on("fragment",({index:e,fragmentIndex:r})=>{n||w({f:0===r||r.toString()},{location:Object.assign(Object.assign({},location),{hash:"#"+(e+1)}),setter:(...e)=>t.history?history.pushState(...e):history.replaceState(...e)})}),setTimeout(()=>{a(),window.addEventListener("hashchange",()=>r(()=>{a({fragment:!1}),w({f:void 0})})),window.addEventListener("popstate",()=>{n||r(()=>a())}),n=!1},0)}}function W(e={}){const t=e.key||((e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let r=63&n[e];t+=r<36?r.toString(36):r<62?(r-26).toString(36).toUpperCase():r<63?"_":"-"}return t})(),n="bespoke-marp-sync-"+t,r=()=>{const e=y.get(n);return e?JSON.parse(e):Object.create(null)},a=e=>{const t=r(),a=Object.assign(Object.assign({},t),e(t));return y.set(n,JSON.stringify(a)),a};return a(e=>({reference:(e.reference||0)+1})),e=>{Object.defineProperty(e,"syncKey",{value:t,enumerable:!0});let s=!0;setTimeout(()=>{e.on("fragment",e=>{s&&a(()=>({index:e.index,fragmentIndex:e.fragmentIndex}))})},0),window.addEventListener("storage",t=>{if(t.key===n&&t.oldValue&&t.newValue){const n=JSON.parse(t.oldValue),r=JSON.parse(t.newValue);if(n.index!==r.index||n.fragmentIndex!==r.fragmentIndex)try{s=!1,e.slide(r.index,{fragment:r.fragmentIndex})}finally{s=!0}}}),e.on("destroy",()=>{const{reference:e}=r();void 0===e||e<=1?y.remove(n):a(()=>({reference:e-1}))})}}function J({slope:e=Math.tan(-35*Math.PI/180),swipeThreshold:t=30}={}){return n=>{let r;const a=n.parent,s=e=>{const t=a.getBoundingClientRect();return{x:e.pageX-(t.left+t.right)/2,y:e.pageY-(t.top+t.bottom)/2}};a.addEventListener("touchstart",e=>{r=1===e.touches.length?s(e.touches[0]):void 0},{passive:!0}),a.addEventListener("touchmove",e=>{if(r)if(1===e.touches.length){e.preventDefault();const t=s(e.touches[0]),n=t.x-r.x,a=t.y-r.y;r.delta=Math.sqrt(Math.pow(Math.abs(n),2)+Math.pow(Math.abs(a),2)),r.radian=Math.atan2(n,a)}else r=void 0}),a.addEventListener("touchend",a=>{if(r){if(r.delta&&r.delta>=t&&r.radian){let t=r.radian-e;t=(t+Math.PI)%(2*Math.PI)-Math.PI,n[t<0?"next":"prev"](),a.stopPropagation()}r=void 0}},{passive:!0})}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function _(e,t,n,r){return new(n||(n=Promise))((function(a,s){function i(e){try{l(r.next(e))}catch(e){s(e)}}function o(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,o)}l((r=r.apply(e,t||[])).next())}))}let G=void 0;const Q=()=>(void 0===G&&(G="wakeLock"in navigator&&navigator.wakeLock),G),Z=()=>_(void 0,void 0,void 0,(function*(){const e=Q();if(e)try{const t=yield e.request("screen");return t.addEventListener("release",()=>{console.debug("[Marp CLI] Wake Lock was released")}),console.debug("[Marp CLI] Wake Lock is active"),t}catch(e){console.warn(e)}return null}));function ee(){return _(this,void 0,void 0,(function*(){if(!Q())return;let e;const t=()=>{e&&"visible"===document.visibilityState&&Z()};return document.addEventListener("visibilitychange",t),document.addEventListener("fullscreenchange",t),e=yield Z(),e}))}const te=[h.Normal,h.Presenter,h.Next];!function(r=document.getElementById("p")){document.body.setAttribute(p,(()=>{switch(b("view")){case"next":return h.Next;case"presenter":return h.Presenter;default:return h.Normal}})());const a=(e=>{const t=b(e);return w({[e]:void 0}),t})("sync")||void 0,s=!1,l=!0,u=e(r,((...e)=>{const t=te.findIndex(e=>v()===e);if(t<0)throw new Error("Invalid view");return e.map(([e,n])=>e[t]&&n).filter(e=>e)})([[l,l,s],W({key:a})],[[l,l,l],Y(r)],[[l,l,s],c],[[l,l,l],t],[[l,s,s],o()],[[l,l,l],d],[[l,l,l],H({history:!1})],[[l,l,s],f()],[[l,l,s],i],[[l,s,s],B],[[l,l,s],J()],[[l,s,s],x()],[[l,l,l],n],[[l,l,s],ee]));window.addEventListener("beforeunload",()=>w({sync:u.syncKey})),window.addEventListener("unload",()=>u.destroy())}()}();</script><script>window.__marpCliWatchWS="ws://localhost:37717/dadb0065a27ae0285feaed7d20ea9e02afc83dd4113d5f333996c4ccc15620e9";!function(){"use strict";const e=(n,o=!1)=>{const t=new WebSocket(n);return t.addEventListener("open",()=>{console.info("[Marp CLI] Observing the change of file..."),o&&location.reload()}),t.addEventListener("close",()=>{console.warn("[Marp CLI] WebSocket for file watcher was disconnected. Try re-connecting in 5000ms..."),setTimeout(()=>e(n,!0),5e3)}),t.addEventListener("message",e=>{"reload"===e.data&&location.reload()}),t};!function(){const n=window.__marpCliWatchWS;if(n)e(n)}()}();</script></body></html>